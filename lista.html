<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ranking ON!</title>

<style>
:root{
  --red:#e50914;
  --cyan:#19d3ff;
  --yellow:#ffc400;
  --green:#2bdc63;
  --glass:rgba(0,0,0,.55);
  --border:rgba(255,255,255,.08);
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:#fff;
  background:
    linear-gradient(rgba(0,0,0,.65),rgba(0,0,0,.75)),
    url("fondoranking2.jpg") center/cover fixed;
}

/* Header */
.header{
  padding:18px 14px 10px 14px;
  position:relative;
}

.headerCard{
  display:flex;
  align-items:center;
  gap:14px;
  padding:14px 14px;
  border-radius:20px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 16px 32px rgba(0,0,0,.35);
}

.logo{
  width:74px;
  flex:0 0 auto;
}

.headerText{
  flex:1 1 auto;
  text-align:center;
  line-height:1.05;
}

.hTop{
  margin:0;
  font-weight:900;
  letter-spacing:4px;
  font-size:clamp(22px,4.2vw,36px);
}
.hTop .on{
  color:#ff4d6d;
  font-weight:900;
}

.hSub{
  margin:6px 0 0;
  font-weight:900;
  color:var(--cyan);
  letter-spacing:3px;
  font-size:clamp(14px,2.8vw,18px);
  text-shadow:0 0 14px rgba(25,211,255,.35);
}

.arrowRight{
  width:0;height:0;
  border-top:14px solid transparent;
  border-bottom:14px solid transparent;
  border-left:22px solid var(--red);
  animation:arrowMove 1.6s ease-in-out infinite, arrowBlink 1.6s ease-in-out infinite;
  flex:0 0 auto;
}

@keyframes arrowMove{
  0%{transform:translateX(0)}
  50%{transform:translateX(10px)}
  100%{transform:translateX(0)}
}
@keyframes arrowBlink{
  0%{opacity:1}
  50%{opacity:.6}
  100%{opacity:1}
}

/* Status bar */
.statusBar{
  margin:12px 0 0;
  padding:12px 14px;
  border-radius:16px;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.10);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.statusLeft{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:800;
}
.dot{
  width:10px;height:10px;border-radius:50%;
  background:var(--yellow);
  box-shadow:0 0 10px rgba(255,196,0,.35);
}
.dot.ok{ background:var(--green); box-shadow:0 0 10px rgba(43,220,99,.35); }
.dot.err{ background:var(--red); box-shadow:0 0 10px rgba(229,9,20,.35); }

.small{
  opacity:.85;
  font-weight:700;
}

/* Lista */
.list{
  padding:14px 14px 40px;
  display:flex;
  flex-direction:column;
  gap:16px;
}

.row{
  display:grid;
  grid-template-columns:58px 54px 1fr 20px 110px;
  align-items:center;
  gap:10px;
  padding:14px;
  border-radius:18px;
  background:var(--glass);
  border:1px solid var(--border);
  box-shadow:0 16px 32px rgba(0,0,0,.4);
  backdrop-filter:blur(6px);
}

.row.top1{
  border:1px solid rgba(229,9,20,.4);
  box-shadow:0 0 20px rgba(229,9,20,.2);
}

.num{
  font-family:Impact,Arial Black,system-ui;
  font-size:38px;
  text-align:center;
}
.row.top1 .num{
  font-size:46px;
  color:var(--red);
}

/* Play/Pause */
.play{
  width:46px;height:46px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,.9);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
}
.play svg{
  fill:#fff;
  width:18px;
}

.song{
  font-weight:900;
  font-size:18px;
  margin:0;
}
.artist{
  margin:4px 0 0;
  font-size:14px;
  opacity:.8;
}

/* Trend */
.trend{
  width:14px;height:14px;
  border-radius:3px;
}
.trend.up{
  width:0;height:0;
  border-left:8px solid transparent;
  border-right:8px solid transparent;
  border-bottom:14px solid var(--green);
}
.trend.down{
  width:0;height:0;
  border-left:8px solid transparent;
  border-right:8px solid transparent;
  border-top:14px solid var(--red);
}
.trend.stable{
  background:var(--yellow);
}

/* Votar */
.vote{
  width:110px;
  height:44px;
  border:0;
  border-radius:14px;
  background:var(--red);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
.vote:disabled{
  opacity:.4;
  cursor:not-allowed;
}

.footer{
  text-align:center;
  padding:10px 0 20px;
  font-weight:800;
  opacity:.85;
}

@media(max-width:520px){
  .logo{width:66px}
  .row{ grid-template-columns:52px 50px 1fr 18px 98px; }
  .vote{ width:98px; }
}
</style>
</head>
<body>

<div class="header">
  <div class="headerCard">
    <img src="logotipo.png" class="logo" alt="ON Radio">
    <div class="headerText">
      <p class="hTop">RANKING <span class="on">ON!</span></p>
      <p class="hSub">VOTÁ TU TEMA FAVORITO</p>
    </div>
    <div class="arrowRight" aria-hidden="true"></div>
  </div>

  <div class="statusBar">
    <div class="statusLeft">
      <span class="dot" id="dot"></span>
      <span id="statusLeft">Conectando…</span>
    </div>
    <div class="small" id="statusRight">Esperando datos</div>
  </div>
</div>

<div class="list" id="list"></div>
<div class="footer">www.laonradio.com.ar</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-database.js";

/* TU CONFIG REAL (COMPLETA) */
const firebaseConfig = {
  apiKey: "AIzaSyC8XXef5k8hLmNL8ufIJsc7Sx5KTlRFdH8",
  authDomain: "on-radio-ranking.firebaseapp.com",
  databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
  projectId: "on-radio-ranking",
  storageBucket: "on-radio-ranking.firebasestorage.app",
  messagingSenderId: "311635352358",
  appId: "1:311635352358:web:257ff4821987f07d31ffe7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const temasRef = ref(db, "temas");

const list = document.getElementById("list");
const statusLeft = document.getElementById("statusLeft");
const statusRight = document.getElementById("statusRight");
const dot = document.getElementById("dot");

/* Audio global + estado */
const audio = new Audio();
audio.preload = "none";
let currentId = null;     // tema actual
let currentBtn = null;    // botón play actual

const ICON_PLAY = <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>;
const ICON_PAUSE = <svg viewBox="0 0 24 24"><path d="M6 5h4v14H6zm8 0h4v14h-4z"/></svg>;

function setStatus(kind, left, right){
  dot.classList.remove("ok","err");
  if(kind === "ok") dot.classList.add("ok");
  if(kind === "err") dot.classList.add("err");
  statusLeft.textContent = left;
  statusRight.textContent = right || "";
}

function today(){
  return new Date().toISOString().slice(0,10);
}
function votedToday(){
  return localStorage.getItem("on_vote") === today();
}
function lockVote(){
  localStorage.setItem("on_vote", today());
}

function stopCurrent(){
  if(currentBtn){
    currentBtn.innerHTML = ICON_PLAY;
  }
  audio.pause();
  audio.currentTime = 0;
  currentId = null;
  currentBtn = null;
}

audio.addEventListener("ended", () => {
  if(currentBtn) currentBtn.innerHTML = ICON_PLAY;
  currentId = null;
  currentBtn = null;
});

setStatus("warn", "Conectando…", "Esperando datos");

let gotFirstSnapshot = false;

onValue(
  temasRef,
  (snap) => {
    gotFirstSnapshot = true;

    const data = snap.val();
    if(!data){
      list.innerHTML = "";
      setStatus("err", "Conectado", "Sin datos en /temas");
      return;
    }

    const temas = Object.entries(data).map(([id,t]) => ({
      id,
      nombre: t?.nombre ?? "",
      artista: t?.artista ?? "",
      audio: t?.audio ?? "",
      votos: Number(t?.votos ?? 0)
    }));

    temas.sort((a,b) => b.votos - a.votos);

    setStatus("ok", "Conectado", Cargados: ${temas.length} temas);
    list.innerHTML = "";

    temas.forEach((t,i) => {
      const row = document.createElement("div");
      row.className = "row" + (i===0 ? " top1" : "");

      row.innerHTML = `
        <div class="num">${i+1}</div>
        <div class="play" data-id="${t.id}">${ICON_PLAY}</div>
        <div>
          <p class="song">${escapeHtml(t.nombre)}</p>
          <p class="artist">${escapeHtml(t.artista)}</p>
        </div>
        <div class="trend stable"></div>
        <button class="vote" ${votedToday() ? "disabled" : ""}>VOTAR</button>
      `;

      const playBtn = row.querySelector(".play");
      const voteBtn = row.querySelector(".vote");

      playBtn.onclick = () => {
        // Si tocás el MISMO tema: toggle play/pause
        if(currentId === t.id){
          if(audio.paused){
            audio.play().catch(()=>{});
            playBtn.innerHTML = ICON_PAUSE;
          }else{
            audio.pause();
            playBtn.innerHTML = ICON_PLAY;
          }
          return;
        }

        // Si tocás OTRO: freno el anterior, reproduzco el nuevo
        stopCurrent();
        currentId = t.id;
        currentBtn = playBtn;

        audio.src = t.audio;
        audio.play().then(() => {
          playBtn.innerHTML = ICON_PAUSE;
        }).catch((e) => {
          setStatus("err", "Audio bloqueado", "El navegador impidió reproducir");
          currentId = null;
          currentBtn = null;
          playBtn.innerHTML = ICON_PLAY;
        });
      };

      voteBtn.onclick = async () => {
        if(votedToday()){
          alert("Ya votaste hoy. Volvé mañana.");
          return;
        }
        try{
          await runTransaction(ref(db, "temas/"+t.id+"/votos"), (v) => (v || 0) + 1);
          lockVote();
          alert("Gracias por votar. Volvé mañana.");
          // deshabilito botones
          document.querySelectorAll(".vote").forEach(b => b.disabled = true);
        }catch(err){
          setStatus("err", "Error votando", "Revisá reglas Firebase");
          alert("No se pudo votar. Revisá reglas de Firebase.");
        }
      };

      list.appendChild(row);
    });
  },
  (err) => {
    // Error real de Firebase (permisos, etc.)
    gotFirstSnapshot = true;
    console.error(err);
    const msg = (err && err.code) ? err.code : "error";
    setStatus("err", "Error Firebase", msg);
    list.innerHTML = "";
  }
);

// Si nunca llega snapshot, aviso
setTimeout(() => {
  if(!gotFirstSnapshot){
    setStatus("err", "No conecta", "Revisá reglas / internet");
  }
}, 5000);

// Sanitizar texto
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>

</body>
</html>
