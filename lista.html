<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ranking ON</title>

<style>
:root{
  --red:#e50914;
  --cyan:#19d3ff;
  --yellow:#ffc400;
  --green:#2bdc63;
  --glass:rgba(0,0,0,.55);
  --glass2:rgba(0,0,0,.70);
  --border:rgba(255,255,255,.10);
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:#fff;
  background:
    linear-gradient(rgba(0,0,0,.65),rgba(0,0,0,.78)),
    url("fondoranking2.jpg") center/cover fixed;
}

/* ===== Header (rectángulo superior) ===== */
.headerWrap{
  padding:14px 12px 8px;
}

.headerBar{
  position:relative;
  display:grid;
  grid-template-columns: 88px 1fr 70px;
  align-items:center;
  gap:10px;

  padding:14px 14px;
  border-radius:22px;
  background:linear-gradient(180deg, rgba(0,0,0,.78), rgba(0,0,0,.55));
  border:1px solid var(--border);
  box-shadow:0 16px 34px rgba(0,0,0,.45);
  backdrop-filter: blur(7px);
}

.logo{
  width:78px;
  justify-self:start;
}

.titles{
  text-align:center;
  line-height:1.05;
}

.hTitle{
  margin:0;
  font-weight:900;
  letter-spacing:3px;
  font-size:clamp(22px,4.2vw,42px);
  text-transform:uppercase;
}

.hTitle .rank{color:#fff;}
.hTitle .on{color:var(--red);}

.subTitle{
  margin:8px 0 0;
  font-weight:900;
  font-size:clamp(14px,2.6vw,18px);
  letter-spacing:2px;
  color:var(--cyan);
  text-shadow: 0 0 14px rgba(25,211,255,.45);
  text-transform:uppercase;
}

.arrowBox{
  justify-self:end;
  width:52px;
  height:52px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.arrowDown{
  width:0;height:0;
  border-left:14px solid transparent;
  border-right:14px solid transparent;
  border-top:22px solid var(--red);
  animation:arrowMove 1.5s ease-in-out infinite, arrowBlink 1.5s ease-in-out infinite;
}

@keyframes arrowMove{
  0%{transform:translateY(0)}
  50%{transform:translateY(10px)}
  100%{transform:translateY(0)}
}
@keyframes arrowBlink{
  0%{opacity:1}
  50%{opacity:.55}
  100%{opacity:1}
}

/* ===== Estado (cartel) ===== */
.status{
  margin:10px 12px 4px;
  padding:12px 14px;
  border-radius:16px;
  background:var(--glass2);
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 14px 26px rgba(0,0,0,.38);
  font-weight:800;
  letter-spacing:.3px;
  display:none;
}
.status.show{display:block;}
.status.ok{border-color:rgba(43,220,99,.35)}
.status.err{border-color:rgba(229,9,20,.35)}
.status.warn{border-color:rgba(255,196,0,.35)}

/* ===== Lista ===== */
.list{
  padding:10px 12px 28px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.row{
  display:grid;
  grid-template-columns:60px 54px 1fr 22px 120px;
  align-items:center;
  gap:10px;
  padding:14px;
  border-radius:18px;
  background:var(--glass);
  border:1px solid var(--border);
  box-shadow:0 16px 32px rgba(0,0,0,.4);
  backdrop-filter:blur(6px);
}

.row.top1{
  border:1px solid rgba(229,9,20,.45);
  box-shadow:0 0 22px rgba(229,9,20,.22);
}

.num{
  font-family:Impact, Arial Black, system-ui;
  font-size:40px;
  text-align:center;
}
.row.top1 .num{
  font-size:48px;
  color:var(--red);
}

.play{
  width:48px;height:48px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
}
.play svg{
  fill:#fff;
  width:20px;
}

.song{
  font-weight:900;
  font-size:18px;
  margin:0;
}
.artist{
  margin:4px 0 0;
  font-size:14px;
  opacity:.82;
}

.trend{
  width:14px;height:14px;
  border-radius:3px;
}
.trend.stable{background:var(--yellow);}

.vote{
  width:120px;
  height:44px;
  border:0;
  border-radius:14px;
  background:var(--red);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
.vote:disabled{opacity:.4; cursor:not-allowed;}

.footer{
  text-align:center;
  padding:8px 0 18px;
  font-weight:800;
  opacity:.85;
}

@media(max-width:520px){
  .row{grid-template-columns:52px 48px 1fr 20px 110px;}
  .vote{width:110px}
}
</style>
</head>

<body>

<div class="headerWrap">
  <div class="headerBar">
    <img src="logotipo.png" class="logo" alt="ON! Radio">
    <div class="titles">
      <h1 class="hTitle"><span class="rank">RANKING</span> <span class="on">ON!</span></h1>
      <div class="subTitle">VOTÁ TU TEMA FAVORITO</div>
    </div>
    <div class="arrowBox" aria-hidden="true">
      <div class="arrowDown"></div>
    </div>
  </div>
</div>

<div id="status" class="status show warn">Cargando temas…</div>
<div class="list" id="list"></div>
<div class="footer">www.laonradio.com.ar</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-database.js";

/* === TU CONFIG REAL (la que me pasaste) === */
const firebaseConfig = {
  apiKey: "AIzaSyC8XXef5k8hLmNL8ufIJsc7Sx5KTlRFdH8",
  authDomain: "on-radio-ranking.firebaseapp.com",
  databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
  projectId: "on-radio-ranking",
  storageBucket: "on-radio-ranking.firebasestorage.app",
  messagingSenderId: "311635352358",
  appId: "1:311635352358:web:257ff4821987f07d31ffe7"
};

const statusEl = document.getElementById("status");
const list = document.getElementById("list");

function setStatus(text, type="warn"){
  statusEl.textContent = text;
  statusEl.className = "status show " + type;
}
function hideStatus(){
  statusEl.className = "status";
}

/* === Voto diario === */
function today(){ return new Date().toISOString().slice(0,10); }
function votedToday(){ return localStorage.getItem("on_vote") === today(); }
function lockVote(){ localStorage.setItem("on_vote", today()); }

/* === Audio play/pause === */
const audio = new Audio();
let currentId = null;
let isPlaying = false;

function playIcon(){
  return <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>;
}
function pauseIcon(){
  return <svg viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>;
}
function setPlayButton(el, playing){
  el.innerHTML = playing ? pauseIcon() : playIcon();
}

audio.addEventListener("ended", ()=>{
  isPlaying = false;
  currentId = null;
  document.querySelectorAll(".play").forEach(btn=>setPlayButton(btn, false));
});

/* === Firebase === */
setStatus("Cargando temas… (conectando a Firebase)", "warn");

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const temasRef = ref(db, "temas");

onValue(
  temasRef,
  (snap)=>{
    const data = snap.val();

    if(!data){
      list.innerHTML = "";
      setStatus("No hay temas en Firebase (ruta /temas vacía).", "warn");
      return;
    }

    const temas = Object.entries(data).map(([id,t])=>({
      id,
      nombre: t.nombre ?? "",
      artista: t.artista ?? "",
      audio: t.audio ?? "",
      votos: Number(t.votos || 0)
    }));

    temas.sort((a,b)=>b.votos-a.votos);
    list.innerHTML = "";

    temas.forEach((t,i)=>{
      const row = document.createElement("div");
      row.className = "row" + (i===0 ? " top1" : "");
      row.innerHTML = `
        <div class="num">${i+1}</div>
        <div class="play" title="Play/Pausa">${playIcon()}</div>
        <div>
          <p class="song">${escapeHtml(t.nombre)}</p>
          <p class="artist">${escapeHtml(t.artista)}</p>
        </div>
        <div class="trend stable"></div>
        <button class="vote" ${votedToday()?"disabled":""}>VOTAR</button>
      `;

      const playBtn = row.querySelector(".play");
      playBtn.onclick = async ()=>{
        // si clickeo el mismo tema que está sonando => toggle pause/play
        if(currentId === t.id){
          if(isPlaying){
            audio.pause();
            isPlaying = false;
            setPlayButton(playBtn, false);
          }else{
            await audio.play().catch(()=>{});
            isPlaying = true;
            setPlayButton(playBtn, true);
          }
          return;
        }

        // si es otro tema => parar el anterior, arrancar éste
        document.querySelectorAll(".play").forEach(btn=>setPlayButton(btn, false));
        currentId = t.id;
        audio.src = t.audio;
        await audio.play().then(()=>{
          isPlaying = true;
          setPlayButton(playBtn, true);
        }).catch((e)=>{
          isPlaying = false;
          setPlayButton(playBtn, false);
          setStatus("No se pudo reproducir el audio (revisá la URL del mp3).", "warn");
          console.error(e);
        });
      };

      row.querySelector(".vote").onclick = async()=>{
        if(votedToday()){
          alert("Ya votaste hoy. Volvé mañana.");
          return;
        }
        try{
          await runTransaction(ref(db, "temas/"+t.id+"/votos"), v => (v||0)+1);
          lockVote();
          // deshabilito todos
          document.querySelectorAll(".vote").forEach(b=>b.disabled=true);
          alert("Gracias por votar. Volvé mañana.");
        }catch(e){
          console.error(e);
          setStatus("Error al votar (permiso de Firebase).", "err");
          alert("No se pudo registrar el voto. Revisá permisos de Firebase.");
        }
      };

      list.appendChild(row);
    });

    hideStatus();
  },
  (err)=>{
    console.error(err);
    list.innerHTML = "";
    // Mensaje humano, sin “código críptico”
    if(String(err?.code||"").includes("permission-denied")){
      setStatus("Firebase bloqueó el acceso: PERMISO DENEGADO. Hay que ajustar Rules del Realtime Database.", "err");
    }else{
      setStatus("Error conectando a Firebase: " + (err?.message || err), "err");
    }
  }
);

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
</script>

</body>
</html>
