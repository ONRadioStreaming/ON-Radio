<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ranking ON</title>

<style>
:root{
  --red:#e50914;
  --cyan:#19d3ff;
  --yellow:#ffc400;
  --green:#2bdc63;
  --glass:rgba(0,0,0,.55);
  --border:rgba(255,255,255,.10);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:#fff;
  background:
    linear-gradient(rgba(0,0,0,.65),rgba(0,0,0,.75)),
    url("fondoranking2.jpg") center/cover fixed;
}

/* Header */
.headerWrap{padding:18px 12px 10px;}
.header{
  max-width:980px;
  margin:0 auto;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.10);
  border-radius:22px;
  box-shadow:0 16px 32px rgba(0,0,0,.45);
  backdrop-filter:blur(7px);
  display:grid;
  grid-template-columns:92px 1fr 70px;
  align-items:center;
  gap:10px;
  padding:14px 14px;
}
.logo{width:78px; justify-self:start;}
.titleBox{ text-align:center; line-height:1.05; }
.title{
  margin:0;
  font-weight:900;
  letter-spacing:2px;
  font-size:clamp(22px,3.6vw,40px);
}
.title .w{color:#fff;}
.title .r{color:var(--red);}
.subtitle{
  margin:6px 0 0;
  font-weight:900;
  letter-spacing:2px;
  color:var(--cyan);
  text-shadow:0 0 14px rgba(25,211,255,.45);
  font-size:clamp(12px,2.2vw,18px);
}
.arrowDown{
  justify-self:end;
  width:0;height:0;
  border-left:14px solid transparent;
  border-right:14px solid transparent;
  border-top:22px solid var(--red);
  animation:arrowMove 1.6s ease-in-out infinite, arrowBlink 1.6s ease-in-out infinite;
  filter:drop-shadow(0 0 12px rgba(229,9,20,.55));
}
@keyframes arrowMove{0%{transform:translateY(0)}50%{transform:translateY(10px)}100%{transform:translateY(0)}}
@keyframes arrowBlink{0%{opacity:1}50%{opacity:.55}100%{opacity:1}}

/* Status */
.statusWrap{padding:6px 12px 0;}
.status{
  max-width:980px;
  margin:0 auto;
  padding:10px 14px;
  border-radius:16px;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.08);
  font-weight:800;
  letter-spacing:.4px;
}
.status.ok{border-color:rgba(43,220,99,.35)}
.status.err{border-color:rgba(229,9,20,.45)}
.status.warn{border-color:rgba(255,196,0,.45)}
.small{opacity:.85; font-weight:700}

/* Lista */
.listWrap{padding:12px 12px 30px;}
.list{
  max-width:980px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.row{
  display:grid;
  grid-template-columns:56px 52px 1fr 120px;
  align-items:center;
  gap:12px;
  padding:14px;
  border-radius:18px;
  background:var(--glass);
  border:1px solid var(--border);
  box-shadow:0 16px 32px rgba(0,0,0,.4);
  backdrop-filter:blur(6px);
}
.num{
  font-family:Impact,Arial Black,system-ui;
  font-size:38px;
  text-align:center;
}
.play{
  width:46px;height:46px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,.85);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.play svg{fill:#fff;width:18px}
.song{font-weight:900;font-size:18px;margin:0}
.artist{margin:4px 0 0;font-size:14px;opacity:.85}
.vote{
  width:120px;height:46px;
  border:0;border-radius:16px;
  background:var(--red);color:#fff;
  font-weight:900;cursor:pointer;
}
.vote:disabled{opacity:.45;cursor:not-allowed}

.footer{
  text-align:center;
  padding:8px 0 18px;
  font-weight:800;
  opacity:.85;
}

@media(max-width:520px){
  .header{grid-template-columns:80px 1fr 64px}
  .logo{width:68px}
  .row{grid-template-columns:46px 46px 1fr 105px}
  .vote{width:105px}
}
</style>
</head>

<body>

<div class="headerWrap">
  <div class="header">
    <img src="logotipo.png" class="logo" alt="ON Radio">
    <div class="titleBox">
      <h1 class="title"><span class="w">RANKING</span> <span class="r">ON</span></h1>
      <div class="subtitle">VOTÁ TU TEMA FAVORITO</div>
    </div>
    <div class="arrowDown" aria-hidden="true"></div>
  </div>
</div>

<div class="statusWrap">
  <div id="status" class="status warn">Cargando temas… <span class="small">(conectando a Firebase)</span></div>
</div>

<div class="listWrap">
  <div class="list" id="list"></div>
</div>

<div class="footer">www.laonradio.com.ar</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
import {
  getDatabase, ref, get, child, runTransaction
} from "https://www.gstatic.com/firebasejs/12.10.0/firebase-database.js";

/** ✅ TU CONFIG (la que me pasaste) */
const firebaseConfig = {
  apiKey: "AIzaSyC8XXef5k8hLmNL8ufIJsc7Sx5KTlRFdH8",
  authDomain: "on-radio-ranking.firebaseapp.com",
  databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
  projectId: "on-radio-ranking",
  storageBucket: "on-radio-ranking.firebasestorage.app",
  messagingSenderId: "311635352358",
  appId: "1:311635352358:web:257ff4821987f07d31ffe7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const statusEl = document.getElementById("status");
const listEl = document.getElementById("list");
const audio = new Audio();

function setStatus(type, msg, small=""){
  statusEl.className = "status " + type;
  statusEl.innerHTML = msg + (small ? ` <span class="small">${small}</span>` : "");
}

function today(){ return new Date().toISOString().slice(0,10); }
function votedToday(){ return localStorage.getItem("on_vote")==today(); }
function lockVote(){ localStorage.setItem("on_vote",today()); }

function normalizeTemas(raw){
  // raw puede venir como {id:{...}, id2:{...}} o como null
  const temas = Object.entries(raw || {}).map(([id,t])=>({
    id,
    nombre: t?.nombre ?? "(Sin nombre)",
    artista: t?.artista ?? "",
    audio: t?.audio ?? "",
    votos: Number(t?.votos ?? 0)
  }));
  temas.sort((a,b)=>b.votos - a.votos);
  return temas;
}

function render(temas){
  listEl.innerHTML = "";
  temas.forEach((t,i)=>{
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="num">${i+1}</div>
      <div class="play" title="Reproducir">
        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </div>
      <div>
        <p class="song">${t.nombre}</p>
        <p class="artist">${t.artista}</p>
      </div>
      <button class="vote" ${votedToday() ? "disabled":""}>VOTAR</button>
    `;

    row.querySelector(".play").onclick = ()=>{
      if(!t.audio){
        alert("Este tema no tiene archivo de audio cargado.");
        return;
      }
      audio.src = t.audio; // ej: "papi.mp3" (en el mismo directorio)
      audio.play().catch(()=>alert("No pude reproducir el audio (revisá el nombre del archivo)."));
    };

    row.querySelector(".vote").onclick = async ()=>{
      if(votedToday()){
        alert("Ya votaste hoy. Volvé mañana.");
        return;
      }
      // ✅ Intento votar en /temas/id/votos y si no existe /temas, intento en /id/votos
      try{
        const temasSnap = await get(ref(db, "temas"));
        const base = temasSnap.exists() ? "temas/" : "";
        await runTransaction(ref(db, base + t.id + "/votos"), v => (v||0)+1);
        lockVote();
        alert("Gracias por votar. Volvé mañana.");
        location.reload();
      }catch(err){
        console.error(err);
        alert("No pude registrar el voto. Revisá permisos de Firebase.");
      }
    };

    listEl.appendChild(row);
  });
}

async function boot(){
  try{
    setStatus("warn", "Cargando temas…", "(leyendo base de datos)");

    // 1) pruebo /temas
    const snapTemas = await get(ref(db, "temas"));
    if(snapTemas.exists()){
      const temas = normalizeTemas(snapTemas.val());
      setStatus("ok", Cargados ${temas.length} temas ✅, "(desde /temas)");
      render(temas);
      return;
    }

    // 2) si /temas no existe, pruebo raíz /
    const snapRoot = await get(ref(db, "/"));
    const rootVal = snapRoot.val();

    // Si la raíz tiene cosas "de sistema" (raro), filtramos por objetos que tengan "nombre"
    const cleaned = {};
    for(const [k,v] of Object.entries(rootVal || {})){
      if(v && typeof v === "object" && ("nombre" in v || "artista" in v || "votos" in v)){
        cleaned[k] = v;
      }
    }

    const temas = normalizeTemas(cleaned);
    if(temas.length === 0){
      setStatus("err", "No encontré temas en /temas ni en la raíz ❌", "(revisá dónde están guardados en Firebase)");
      return;
    }

    setStatus("ok", Cargados ${temas.length} temas ✅, "(desde raíz /)");
    render(temas);

  } catch (err){
    console.error("Firebase error:", err);
    // Esto te va a decir EXACTO si es permisos (permission_denied)
    setStatus("err", "Error Firebase ❌", String(err?.message || err));
  }
}

boot();
</script>

</body>
</html>
