<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ranking ON</title>

<style>
:root{
  --red:#e50914;
  --cyan:#19d3ff;
  --yellow:#ffc400;
  --green:#2bdc63;
  --glass:rgba(0,0,0,.55);
  --border:rgba(255,255,255,.08);
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:#fff;
  background:
    linear-gradient(rgba(0,0,0,.65),rgba(0,0,0,.75)),
    url("fondoranking2.jpg") center/cover fixed;
}

/* Header */
.header{
  padding:16px 14px 10px;
  position:relative;
  text-align:center;
}

.headerBox{
  position:relative;
  margin:14px auto 0;
  max-width:980px;
  border-radius:22px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 18px 40px rgba(0,0,0,.45);
  backdrop-filter:blur(7px);
  padding:14px 18px;
  display:grid;
  grid-template-columns:90px 1fr 90px;
  align-items:center;
  gap:10px;
}

.logo{
  width:82px;
  justify-self:start;
}

.titleWrap{
  text-align:center;
}

.bigTitle{
  margin:0;
  font-weight:1000;
  letter-spacing:3px;
  font-size:clamp(26px,4vw,42px);
  text-shadow:0 0 14px rgba(0,0,0,.35);
}
.bigTitle .rank{color:#fff}
.bigTitle .on{color:var(--red)}
.subTitle{
  margin:6px 0 0;
  font-weight:900;
  letter-spacing:2px;
  color:var(--cyan);
  text-shadow:0 0 16px rgba(25,211,255,.45);
  font-size:clamp(14px,2.2vw,18px);
}

/* Flecha (dentro del rectángulo, lateral derecho) */
.arrowWrap{
  justify-self:end;
  width:60px;
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.arrowDown{
  width:0;height:0;
  border-left:16px solid transparent;
  border-right:16px solid transparent;
  border-top:26px solid var(--red);
  animation:arrowMove 1.3s ease-in-out infinite, arrowBlink 1.3s ease-in-out infinite;
  filter:drop-shadow(0 0 10px rgba(229,9,20,.35));
}

@keyframes arrowMove{
  0%{transform:translateY(0)}
  50%{transform:translateY(10px)}
  100%{transform:translateY(0)}
}
@keyframes arrowBlink{
  0%{opacity:1}
  50%{opacity:.55}
  100%{opacity:1}
}

/* Estado / cartel */
.status{
  max-width:980px;
  margin:12px auto 0;
  padding:12px 14px;
  border-radius:16px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 12px 26px rgba(0,0,0,.35);
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:space-between;
}
.pill{
  display:inline-flex;
  gap:8px;
  align-items:center;
  font-weight:900;
  letter-spacing:.4px;
}
.dot{
  width:10px;height:10px;border-radius:999px;
  background:var(--yellow);
  box-shadow:0 0 12px rgba(255,196,0,.35);
}
.small{
  opacity:.85;
  font-weight:700;
  font-size:13px;
}

/* Lista */
.list{
  max-width:980px;
  margin:14px auto 0;
  padding:10px 14px 40px;
  display:flex;
  flex-direction:column;
  gap:16px;
}

.row{
  display:grid;
  grid-template-columns:55px 50px 1fr 20px 110px;
  align-items:center;
  gap:10px;
  padding:14px;
  border-radius:18px;
  background:var(--glass);
  border:1px solid var(--border);
  box-shadow:0 16px 32px rgba(0,0,0,.4);
  backdrop-filter:blur(6px);
}

.row.top1{
  border:1px solid rgba(229,9,20,.4);
  box-shadow:0 0 22px rgba(229,9,20,.22);
}

.num{
  font-family:Impact,Arial Black,system-ui;
  font-size:36px;
  text-align:center;
}
.row.top1 .num{
  font-size:44px;
  color:var(--red);
}

/* Play */
.play{
  width:46px;height:46px;
  border-radius:50%;
  border:2px solid #fff;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
}
.play svg{
  fill:#fff;
  width:18px;
}

/* Info */
.song{
  font-weight:900;
  font-size:18px;
  margin:0;
}
.artist{
  margin:4px 0 0;
  font-size:14px;
  opacity:.8;
}

/* Trend */
.trend{
  width:14px;height:14px;
  border-radius:3px;
}
.trend.up{
  width:0;height:0;
  border-left:8px solid transparent;
  border-right:8px solid transparent;
  border-bottom:14px solid var(--green);
}
.trend.down{
  width:0;height:0;
  border-left:8px solid transparent;
  border-right:8px solid transparent;
  border-top:14px solid var(--red);
}
.trend.stable{
  background:var(--yellow);
}

/* Votar */
.vote{
  width:110px;
  height:44px;
  border:0;
  border-radius:14px;
  background:var(--red);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
.vote:disabled{
  opacity:.4;
  cursor:not-allowed;
}

/* Footer */
.footer{
  text-align:center;
  padding:10px 0 20px;
  font-weight:800;
  opacity:.85;
}

/* Responsive */
@media(max-width:520px){
  .headerBox{
    grid-template-columns:80px 1fr 70px;
    padding:12px 12px;
  }
  .logo{width:70px}
  .row{
    grid-template-columns:45px 45px 1fr 18px 95px;
  }
  .vote{width:95px}
}
</style>
</head>
<body>

<div class="header">
  <div class="headerBox">
    <img src="logotipo.png" class="logo" alt="ON Radio">
    <div class="titleWrap">
      <h1 class="bigTitle"><span class="rank">RANKING</span> <span class="on">ON!</span></h1>
      <div class="subTitle">VOTÁ TU TEMA FAVORITO</div>
    </div>
    <div class="arrowWrap" aria-hidden="true">
      <div class="arrowDown"></div>
    </div>
  </div>

  <div class="status" id="statusBox">
    <div class="pill"><span class="dot" id="statusDot"></span> <span id="statusText">Conectando…</span></div>
    <div class="small" id="statusDetail">Esperando datos</div>
  </div>
</div>

<div class="list" id="list"></div>

<div class="footer">www.laonradio.com.ar</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC8XXef5k8hLmNL8ufIJsc7Sx5KTlRFdH8",
  authDomain: "on-radio-ranking.firebaseapp.com",
  databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
  projectId: "on-radio-ranking",
  storageBucket: "on-radio-ranking.firebasestorage.app",
  messagingSenderId: "311635352358",
  appId: "1:311635352358:web:257ff4821987f07d31ffe7"
};

const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const statusDetail = document.getElementById("statusDetail");

function setStatus(kind, text, detail){
  statusText.textContent = text;
  statusDetail.textContent = detail || "";
  if(kind === "ok"){
    statusDot.style.background = "var(--green)";
    statusDot.style.boxShadow = "0 0 12px rgba(43,220,99,.35)";
  } else if(kind === "bad"){
    statusDot.style.background = "var(--red)";
    statusDot.style.boxShadow = "0 0 12px rgba(229,9,20,.35)";
  } else {
    statusDot.style.background = "var(--yellow)";
    statusDot.style.boxShadow = "0 0 12px rgba(255,196,0,.35)";
  }
}

let app, db;
try{
  app = initializeApp(firebaseConfig);
  db = getDatabase(app);
  setStatus("mid","Conectando…","Firebase inicializado");
}catch(e){
  console.error("Firebase init error:", e);
  setStatus("bad","Error al iniciar Firebase","Revisá consola (F12) – init falló");
}

const temasRef = ref(db,"temas");
const list = document.getElementById("list");

// Audio con play/pause real
const audio = new Audio();
let currentId = null;
let isPlaying = false;

function today(){ return new Date().toISOString().slice(0,10); }
function votedToday(){ return localStorage.getItem("on_vote")==today(); }
function lockVote(){ localStorage.setItem("on_vote",today()); }

// Iconos
const ICON_PLAY = <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>;
const ICON_PAUSE = <svg viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>;

function setPlayIcon(el, playing){
  el.innerHTML = playing ? ICON_PAUSE : ICON_PLAY;
}

onValue(temasRef,(snap)=>{
  const data = snap.val();

  if(!data){
    setStatus("bad","No hay datos en /temas","Firebase conectó pero la ruta está vacía");
    list.innerHTML = "";
    return;
  }

  const temas = Object.entries(data).map(([id,t])=>({
    id,
    nombre: t.nombre || "Sin título",
    artista: t.artista || "",
    audio: t.audio || "",
    votos: Number(t.votos||0)
  }));

  temas.sort((a,b)=>b.votos-a.votos);

  setStatus("ok","Conectado","Temas cargados: " + temas.length);
  list.innerHTML = "";

  temas.forEach((t,i)=>{
    const row=document.createElement("div");
    row.className="row"+(i===0?" top1":"");

    row.innerHTML=`
      <div class="num">${i+1}</div>
      <div class="play" role="button" aria-label="Reproducir/Pausar">
        ${ICON_PLAY}
      </div>
      <div>
        <p class="song">${escapeHtml(t.nombre)}</p>
        <p class="artist">${escapeHtml(t.artista)}</p>
      </div>
      <div class="trend stable"></div>
      <button class="vote" ${votedToday()?"disabled":""}>VOTAR</button>
    `;

    const playEl = row.querySelector(".play");
    const voteBtn = row.querySelector(".vote");

    // Play/Pause real
    playEl.onclick = ()=>{
      if(!t.audio){
        alert("Este tema no tiene link de audio cargado.");
        return;
      }

      // si es el mismo tema
      if(currentId === t.id){
        if(isPlaying){
          audio.pause();
          isPlaying = false;
          setPlayIcon(playEl,false);
        }else{
          audio.play().catch(err=>console.error(err));
          isPlaying = true;
          setPlayIcon(playEl,true);
        }
        return;
      }

      // cambio de tema
      currentId = t.id;
      audio.src = t.audio;
      audio.play().then(()=>{
        isPlaying = true;
        // reset iconos de otras filas
        document.querySelectorAll(".play").forEach(p=>setPlayIcon(p,false));
        setPlayIcon(playEl,true);
      }).catch(err=>{
        console.error("Audio play error:", err);
        alert("No se pudo reproducir el audio. Revisá el link del mp3.");
      });
    };

    // cuando termina el audio, vuelve a play
    audio.onended = ()=>{
      isPlaying = false;
      currentId = null;
      document.querySelectorAll(".play").forEach(p=>setPlayIcon(p,false));
    };

    voteBtn.onclick = async()=>{
      if(votedToday()){
        alert("Ya votaste hoy. Volvé mañana.");
        return;
      }
      try{
        await runTransaction(ref(db,"temas/"+t.id+"/votos"), v => (v||0)+1);
        lockVote();
        alert("Gracias por votar. Volvé mañana.");
      }catch(e){
        console.error("Vote error:", e);
        alert("No se pudo registrar el voto. Revisá reglas de Firebase.");
      }
    };

    list.appendChild(row);
  });
}, (err)=>{
  console.error("onValue error:", err);
  setStatus("bad","No se puede leer Firebase","Probable: reglas/permiso o config");
});

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}
</script>

</body>
</html>
