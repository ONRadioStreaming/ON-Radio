<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ranking ON Radio</title>

  <!-- Fuentes (para el “RANKING ON” y título) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Montserrat:wght@600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #000;
      --glass: rgba(0,0,0,.42);
      --glass2: rgba(0,0,0,.55);
      --stroke: rgba(255,255,255,.10);
      --white: #fff;
      --red: #e60000;
      --cyan: #45f3ff;
      --green: #35d07f;
      --yellow: #f6c343;
      --muted: rgba(255,255,255,.75);
      --muted2: rgba(255,255,255,.55);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--white);
      background: var(--bg);
      overflow-x:hidden;
    }

    /* Fondo */
    .bg{
      position:fixed;
      inset:0;
      background:
        linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.75)),
        url("fondoranking2.jpg");
      background-size: cover;
      background-position: center;
      background-repeat:no-repeat;
      z-index:-2;
    }

    /* Capa oscura leve para que todo lea mejor */
    .veil{
      position:fixed;
      inset:0;
      background: radial-gradient(circle at 40% 0%, rgba(0,0,0,.15), rgba(0,0,0,.55));
      z-index:-1;
    }

    /* RANKING ON fijo (como tu referencia) */
    .rank-fixed{
      position: fixed;
      left: 10px;
      top: 50%;
      transform: translateY(-50%) rotate(180deg);
      writing-mode: vertical-rl;
      z-index: 50;
      pointer-events:none;
      user-select:none;

      font-family: Anton, sans-serif;
      letter-spacing: 4px;
      font-size: clamp(46px, 7vw, 88px);
      color: #fff;
      text-transform: uppercase;
      text-shadow:
        0 0 10px rgba(255,255,255,.20),
        0 0 20px rgba(255,255,255,.10);
      opacity:.95;
    }
    .rank-fixed .on{
      font-size: 1.12em;
      letter-spacing: 2px;
      margin-top: 10px;
    }

    /* Layout principal */
    .wrap{
      width:min(1080px, 100%);
      margin: 0 auto;
      padding: 18px 14px 28px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 16px;
      margin-top: 12px;
      position:relative;
      padding-left: 74px; /* deja espacio para el RANKING ON fijo */
      padding-right: 12px;
    }

    .logo{
      position:absolute;
      right: 12px;
      top: 0;
      width: clamp(60px, 8vw, 92px);
      height:auto;
      filter: drop-shadow(0 0 10px rgba(0,0,0,.55));
    }

    .titleBox{
      text-align:center;
      padding: 10px 10px 6px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
      backdrop-filter: blur(2px);
      border: 1px solid rgba(255,255,255,.06);
      width: 100%;
      max-width: 820px;
    }

    .title{
      margin: 0;
      font-weight: 900;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: clamp(22px, 3.6vw, 42px);
      color: var(--cyan);
      text-shadow:
        0 0 10px rgba(69,243,255,.25),
        0 0 22px rgba(69,243,255,.15);
    }

    /* Flecha alineada a la columna de VOTAR (derecha) */
    .voteArrow{
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 16px solid var(--cyan);
      margin: 8px 0 0 auto; /* empuja a la derecha */
      filter: drop-shadow(0 0 10px rgba(69,243,255,.25));
    }
    .voteArrowWrap{
      display:flex;
      align-items:flex-end;
      justify-content:flex-end;
      width: 100%;
      max-width: 820px;
      margin: 0 auto;
      padding-right: 18px; /* coincide con padding de botones */
    }

    /* Lista */
    .list{
      margin-top: 14px;
      padding-left: 74px; /* deja espacio para “RANKING ON” fijo */
    }

    .row{
      display:grid;
      grid-template-columns: 72px 64px 1fr 28px 132px; /* #, play, info, flecha, votar */
      align-items:center;
      gap: 10px;
      padding: 12px 14px;
      margin: 10px 0;
      border-radius: 16px;
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      overflow:hidden;
    }

    .row.top1{
      border-color: rgba(230,0,0,.35);
      background: linear-gradient(180deg, rgba(230,0,0,.15), rgba(0,0,0,.55));
    }

    /* Números: usa Benjamin Gothic Heavy si existe en tu PC, si no cae a Franklin/Arial Black */
    .pos{
      font-family: "Benjamin Gothic Heavy", "Franklin Gothic Heavy", "Arial Black", Anton, sans-serif;
      font-weight: 900;
      font-size: 38px;
      letter-spacing: 1px;
      color: #fff;
      opacity:.95;
      text-align:left;
    }
    .top1 .pos{
      color: var(--red);
      font-size: 46px;
    }

    .playBtn{
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.20);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease;
      user-select:none;
    }
    .playBtn:hover{ transform: scale(1.02); border-color: rgba(255,255,255,.35); }

    /* Ícono play/pause */
    .icon{
      width: 0; height: 0;
      border-top: 9px solid transparent;
      border-bottom: 9px solid transparent;
      border-left: 14px solid rgba(255,255,255,.85);
      margin-left: 3px;
    }
    .paused .icon{
      border: none;
      width: 14px;
      height: 16px;
      margin-left: 0;
      display:flex;
      gap:4px;
    }
    .paused .icon::before,
    .paused .icon::after{
      content:"";
      display:block;
      width:5px;
      height:16px;
      background: rgba(255,255,255,.85);
      border-radius:2px;
    }

    .info .song{
      font-weight: 900;
      font-size: 18px;
      line-height: 1.1;
    }
    .info .artist{
      margin-top: 3px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.15;
    }

    /* Indicador sube/baja/estable */
    .trend{
      width: 0; height: 0;
      justify-self:center;
      filter: drop-shadow(0 0 8px rgba(0,0,0,.35));
    }
    .trend.up{
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 14px solid var(--green);
    }
    .trend.down{
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 14px solid var(--red);
    }
    .trend.same{
      width: 14px; height: 14px;
      background: var(--yellow);
      border-radius: 3px;
    }

    .voteBtn{
      justify-self:end;
      width: 120px;
      padding: 12px 10px;
      border: none;
      border-radius: 12px;
      background: var(--red);
      color:#fff;
      font-weight: 900;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      transition: transform .08s ease, filter .15s ease, opacity .15s ease;
    }
    .voteBtn:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .voteBtn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
      filter:none;
    }

    /* Footer */
    .footer{
      margin-top: 16px;
      padding-left: 74px;
      text-align:center;
      color: rgba(255,255,255,.85);
      font-weight: 700;
      letter-spacing: 1px;
      font-size: 14px;
      text-shadow: 0 0 10px rgba(0,0,0,.55);
    }

    /* Responsive */
    @media (max-width: 640px){
      .row{
        grid-template-columns: 58px 56px 1fr 24px 108px;
        padding: 12px 12px;
      }
      .pos{ font-size: 34px; }
      .top1 .pos{ font-size: 42px; }
      .voteBtn{ width: 104px; padding: 11px 8px; border-radius: 11px; }
      .info .song{ font-size: 16px; }
      .logo{ right: 8px; }
      .voteArrowWrap{ padding-right: 10px; }
    }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="veil"></div>

  <div class="rank-fixed">
    <span>RANKING</span>
    <span class="on">ON</span>
  </div>

  <div class="wrap">
    <header class="topbar">
      <img class="logo" src="logotipo.png" alt="ON Radio Streaming">
      <div class="titleBox">
        <h1 class="title">VOTÁ TU TEMA PREFERIDO</h1>
        <div class="voteArrowWrap"><div class="voteArrow" aria-hidden="true"></div></div>
      </div>
    </header>

    <main class="list" id="list">
      <!-- Se renderiza por JS -->
    </main>

    <div class="footer">www.laonradio.com.ar</div>
  </div>

  <!-- Audio único compartido -->
  <audio id="player" preload="none"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getDatabase, ref, onValue, get, runTransaction, update
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    // Firebase config (tuyo)
    const firebaseConfig = {
      apiKey: "AIzaSyC8XXef5k8hLmNL8ufIJsc7Sx5KTlRFdH8",
      authDomain: "on-radio-ranking.firebaseapp.com",
      databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
      projectId: "on-radio-ranking",
      storageBucket: "on-radio-ranking.firebasestorage.app",
      messagingSenderId: "311635352358",
      appId: "1:311635352358:web:257ff4821987f07d31ffe7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // refs
    const temasRef = ref(db, "temas");
    const metaRef  = ref(db, "meta/prevOrder");

    // UI
    const listEl = document.getElementById("list");
    const audioEl = document.getElementById("player");

    // Estado
    let temasMap = {};
    let prevOrder = null; // array ids
    let currentPlayingId = null;

    // ====== VOTO 1 POR DÍA (TOTAL) ======
    function todayKey(){
      const d = new Date();
      // YYYY-MM-DD (local)
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function votedToday(){
      return localStorage.getItem("onradio_vote_day") === todayKey();
    }
    function markVotedToday(){
      localStorage.setItem("onradio_vote_day", todayKey());
    }

    // ====== Helpers ======
    function escapeHtml(s=""){
      return s.replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function sortIdsByVotes(map){
      return Object.entries(map)
        .map(([id, t]) => ({ id, ...t, votos: Number(t?.votos||0) }))
        .sort((a,b) => {
          if (b.votos !== a.votos) return b.votos - a.votos;
          return String(a.nombre||"").localeCompare(String(b.nombre||""), "es", { sensitivity:"base" });
        })
        .map(x => x.id);
    }

    function trendFor(id, currentOrder, prevOrderArr){
      if (!Array.isArray(prevOrderArr) || prevOrderArr.length === 0) return "same";
      const now = currentOrder.indexOf(id);
      const before = prevOrderArr.indexOf(id);
      if (now === -1 || before === -1) return "same";
      if (now < before) return "up";
      if (now > before) return "down";
      return "same";
    }

    // ====== Player ======
    function setPlayButtonState(rowEl, isPlaying){
      const btn = rowEl.querySelector(".playBtn");
      if (!btn) return;
      if (isPlaying){
        btn.classList.add("paused"); // muestra ícono pause
      } else {
        btn.classList.remove("paused");
      }
    }

    function stopAllPlayButtons(){
      document.querySelectorAll(".row").forEach(r => setPlayButtonState(r, false));
    }

    function playTrack(id){
      const t = temasMap[id];
      if (!t) return;
      const src = encodeURI(String(t.audio||"").trim());
      if (!src) return;

      // toggle
      if (currentPlayingId === id && !audioEl.paused){
        audioEl.pause();
        return;
      }

      currentPlayingId = id;
      audioEl.src = src;
      audioEl.play().catch(()=>{});
      stopAllPlayButtons();
      const row = document.querySelector(`.row[data-id="${CSS.escape(id)}"]`);
      if (row) setPlayButtonState(row, true);
    }

    audioEl.addEventListener("pause", ()=>{
      stopAllPlayButtons();
    });
    audioEl.addEventListener("ended", ()=>{
      stopAllPlayButtons();
      currentPlayingId = null;
    });

    // ====== Vote ======
    async function voteFor(id){
      // 1 voto por día TOTAL
      if (votedToday()){
        alert("Gracias por votar tu tema preferido. Recordá que podés votar una sola vez por día. Volvé mañana para votar otra vez.");
        return;
      }

      // Tomo el orden anterior (ANTES de sumar)
      const oldOrder = sortIdsByVotes(temasMap);

      // Incremento con transaction
      const votoRef = ref(db, `temas/${id}/votos`);
      try{
        await runTransaction(votoRef, (current)=>{
          const n = Number(current||0);
          return n + 1;
        });

        // Guardo en DB el orden previo para flechas “reales”
        // (Así todos comparan contra el último “estado anterior” global)
        await update(ref(db, "meta"), {
          prevOrder: oldOrder,
          prevOrderAt: Date.now()
        });

        markVotedToday();
        alert("Gracias por votar tu tema preferido. Recordá que podés votar una sola vez por día. Volvé mañana para votar otra vez.");
      }catch(e){
        console.error(e);
        alert("No se pudo registrar el voto. Probá de nuevo.");
      }
    }

    // ====== Render ======
    function render(){
      const ids = sortIdsByVotes(temasMap);
      const canVote = !votedToday();

      const html = ids.map((id, idx)=>{
        const t = temasMap[id] || {};
        const pos = idx + 1;
        const song = escapeHtml(String(t.nombre||""));
        const artist = escapeHtml(String(t.artista||""));
        const tr = trendFor(id, ids, prevOrder);

        return `
          <div class="row ${pos===1 ? "top1" : ""}" data-id="${escapeHtml(id)}">
            <div class="pos">${pos}</div>

            <div class="playBtn" role="button" aria-label="Reproducir ${song}" data-play="${escapeHtml(id)}">
              <div class="icon"></div>
            </div>

            <div class="info">
              <div class="song">${song}</div>
              <div class="artist">${artist}</div>
            </div>

            <div class="trend ${tr}" title="${tr === "up" ? "Subió" : tr === "down" ? "Bajó" : "Se mantiene"}"></div>

            <button class="voteBtn" data-vote="${escapeHtml(id)}" ${canVote ? "" : "disabled"}>
              VOTAR
            </button>
          </div>
        `;
      }).join("");

      listEl.innerHTML = html;

      // Events
      listEl.querySelectorAll("[data-play]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          playTrack(btn.getAttribute("data-play"));
        });
      });

      listEl.querySelectorAll("[data-vote]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          voteFor(btn.getAttribute("data-vote"));
        });
      });
    }

    // ====== Subscriptions ======
    onValue(temasRef, (snap)=>{
      temasMap = snap.val() || {};
      render();
    });

    onValue(metaRef, (snap)=>{
      prevOrder = snap.val() || null;
      render();
    });
  </script>
</body>
</html>
