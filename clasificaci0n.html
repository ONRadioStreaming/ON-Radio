<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ranking ON</title>

<style>
:root{
  --red:#e50914;
  --cyan:#19d3ff;
  --yellow:#ffc400;
  --green:#2bdc63;
  --glass:rgba(0,0,0,.55);
  --border:rgba(255,255,255,.08);
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:#fff;
  background:
    linear-gradient(rgba(0,0,0,.65),rgba(0,0,0,.75)),
    url("fondoranking2.jpg") center/cover fixed;
}

/* Lateral fijo */
.side{
  position:fixed;
  left:12px;
  top:50%;
  transform:translateY(-50%);
  writing-mode:vertical-rl;
  transform-origin:center;
  font-weight:900;
  letter-spacing:8px;
  font-size:46px;
  opacity:.18;
  pointer-events:none;
}

/* Header */
.header{
  padding:20px 14px 10px 70px;
  position:relative;
  text-align:center;
}

.logo{
  position:absolute;
  left:14px;
  top:14px;
  width:85px;
}

.title{
  font-weight:900;
  font-size:clamp(26px,4vw,44px);
  letter-spacing:3px;
  color:var(--cyan);
  text-shadow:0 0 14px rgba(25,211,255,.4);
  margin:0;
}

.arrowDown{
  margin:14px auto 0;
  width:0;height:0;
  border-left:14px solid transparent;
  border-right:14px solid transparent;
  border-top:22px solid var(--red);
  animation:arrowMove 1.6s ease-in-out infinite,
            arrowBlink 1.6s ease-in-out infinite;
}

@keyframes arrowMove{
  0%{transform:translateY(0)}
  50%{transform:translateY(10px)}
  100%{transform:translateY(0)}
}
@keyframes arrowBlink{
  0%{opacity:1}
  50%{opacity:.6}
  100%{opacity:1}
}

/* Lista */
.list{
  padding:10px 14px 40px 70px;
  display:flex;
  flex-direction:column;
  gap:16px;
}

.row{
  display:grid;
  grid-template-columns:55px 50px 1fr 44px 110px;
  align-items:center;
  gap:10px;
  padding:14px;
  border-radius:18px;
  background:var(--glass);
  border:1px solid var(--border);
  box-shadow:0 16px 32px rgba(0,0,0,.4);
  backdrop-filter:blur(6px);
}

.row.top1{
  border:1px solid rgba(229,9,20,.45);
  box-shadow:0 0 24px rgba(229,9,20,.22);
}

.num{
  font-family:Impact, Arial Black, system-ui;
  font-size:36px;
  text-align:center;
}
.row.top1 .num{
  font-size:44px;
  color:var(--red);
}

/* Play */
.play{
  width:46px;height:46px;
  border-radius:50%;
  border:2px solid rgba(255,255,255,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  user-select:none;
}
.play svg{ fill:#fff; width:18px; opacity:.95; }
.row.playing .play{
  border-color:var(--cyan);
  box-shadow:0 0 18px rgba(25,211,255,.25);
}

/* Info */
.song{
  font-weight:900;
  font-size:18px;
  margin:0;
  line-height:1.15;
}
.artist{
  margin:6px 0 0;
  font-size:14px;
  opacity:.8;
}

/* Votos */
.votos{
  height:44px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:14px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.08);
  font-weight:900;
  letter-spacing:.5px;
}

/* Votar */
.vote{
  width:110px;
  height:44px;
  border:0;
  border-radius:14px;
  background:var(--red);
  color:#fff;
  font-weight:900;
  cursor:pointer;
}
.vote:disabled{
  opacity:.4;
  cursor:not-allowed;
}

/* Footer */
.footer{
  text-align:center;
  padding:10px 0 20px;
  font-weight:700;
  opacity:.85;
}

/* Toast */
.toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  background:rgba(0,0,0,.78);
  border:1px solid rgba(255,255,255,.10);
  padding:10px 14px;
  border-radius:12px;
  font-weight:800;
  letter-spacing:.2px;
  opacity:0;
  pointer-events:none;
  transition:opacity .25s ease, transform .25s ease;
}
.toast.show{
  opacity:1;
  transform:translateX(-50%) translateY(-6px);
}

/* Responsive */
@media(max-width:520px){
  .header,.list{padding-left:60px}
  .side{font-size:38px}
  .logo{width:70px}
  .row{
    grid-template-columns:45px 45px 1fr 40px 95px;
  }
  .vote{width:95px}
}
</style>
</head>

<body>
<div class="side">RANKING ON</div>

<div class="header">
  <img src="logotipo.png" class="logo" alt="ON Radio">
  <h1 class="title">VOT√Å TU TEMA PREFERIDO</h1>
  <div class="arrowDown"></div>
</div>

<div class="list" id="list"></div>

<div class="footer">www.laonradio.com.ar</div>
<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

/* =========================
   1) CONFIG FIREBASE (TUYO)
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyC8XXef5k8hLmNL8ufIJsC7Sx5KT1RFdH8",
  authDomain: "on-radio-ranking.firebaseapp.com",
  databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
  projectId: "on-radio-ranking",
  storageBucket: "on-radio-ranking.firebasestorage.app",
  messagingSenderId: "311635352358",
  appId: "1:311635352358:web:257ff4821987f07d31ffe7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* OJO: tu nodo es "temas" */
const temasRef = ref(db, "temas");

const list = document.getElementById("list");
const toastEl = document.getElementById("toast");

/* Un solo audio sonando */
const audio = new Audio();
let currentId = null;

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1700);
}

function today(){
  return new Date().toISOString().slice(0,10);
}
function votedToday(){
  return localStorage.getItem("on_vote") === today();
}
function lockVote(){
  localStorage.setItem("on_vote", today());
}

function iconPlay(){
  return <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>;
}
function iconPause(){
  return <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 5h4v14H7zm6 0h4v14h-4z"/></svg>;
}

function safeText(s){
  return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* Render */
onValue(temasRef, (snap) => {
  const data = snap.val();
  if(!data){
    list.innerHTML = "";
    toast("No hay temas en la base todav√≠a.");
    return;
  }

  const temas = Object.entries(data).map(([id, t]) => ({
    id,
    nombre: t.nombre ?? id,
    artista: t.artista ?? "",
    audio: t.audio ?? "",
    votos: Number(t.votos || 0)
  }));

  temas.sort((a,b)=> b.votos - a.votos);

  list.innerHTML = "";

  temas.forEach((t, i) => {
    const row = document.createElement("div");
    row.className = "row" + (i===0 ? " top1" : "") + (t.id===currentId ? " playing" : "");

    row.innerHTML = `
      <div class="num">${i+1}</div>

      <div class="play" title="Reproducir / Pausar">
        ${t.id===currentId && !audio.paused ? iconPause() : iconPlay()}
      </div>

      <div>
        <p class="song">${safeText(t.nombre)}</p>
        <p class="artist">${safeText(t.artista)}</p>
      </div>

      <div class="votos" title="Votos">${t.votos}</div>

      <button class="vote" ${votedToday() ? "disabled" : ""}>VOTAR</button>
    `;

    /* PLAY/PAUSE */
    row.querySelector(".play").onclick = async () => {
      if(!t.audio){
        toast("Este tema no tiene audio cargado.");
        return;
      }

      // Si clickeas el mismo tema => toggle play/pause
      if(currentId === t.id){
        if(audio.paused){
          await audio.play().catch(()=>{});
          toast("‚ñ∂ Reproduciendo");
        }else{
          audio.pause();
          toast("‚è∏ Pausa");
        }
      }else{
        currentId = t.id;
        audio.pause();
        audio.currentTime = 0;
        audio.src = t.audio;     // mp3 en el mismo lugar que el html
        await audio.play().catch(()=>{});
        toast("‚ñ∂ Reproduciendo");
      }

      // re-render suave: actualizo iconos sin romper todo
      // (simple: volvemos a pedir render con un truquito)
      // forzamos un repaint minimal:
      // (la base se vuelve a re-renderizar igual con onValue cuando cambie votos)
      document.querySelectorAll(".row").forEach(r=>r.classList.remove("playing"));
      row.classList.add("playing");
      row.querySelector(".play").innerHTML = (!audio.paused && currentId===t.id) ? iconPause() : iconPlay();
    };

    audio.onended = () => {
      currentId = null;
      document.querySelectorAll(".row").forEach(r=>r.classList.remove("playing"));
    };

    /* VOTAR */
    row.querySelector(".vote").onclick = async () => {
      if(votedToday()){
        toast("Ya votaste hoy. Volv√© ma√±ana.");
        return;
      }

      try{
        await runTransaction(ref(db, temas/${t.id}/votos), (v) => (Number(v)||0) + 1);
        lockVote();
        toast("Gracias por votar üôå");
      }catch(e){
        console.error(e);
        toast("Error al votar (reglas de Firebase).");
      }
    };

    list.appendChild(row);
  });
});
</script>
</body>
</html>
