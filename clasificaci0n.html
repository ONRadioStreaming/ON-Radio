<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ranking ON</title>

  <style>
    :root{
      --cyan:#22d3ee;
      --red:#e10600;
      --soft:#ffffffcc;
      --card:#000000b8;
      --card2:#00000090;
      --stroke:#ffffff22;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#fff;
      background:
        url("fondoranking2.jpg") center/cover no-repeat fixed,
        #000;
    }

    /* overlay suave para que lea bien */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:linear-gradient(180deg,#00000055,#00000088);
      pointer-events:none;
      z-index:0;
    }

    .wrap{
      position:relative;
      z-index:1;
      width:min(980px, 100%);
      margin:0 auto;
      padding:18px 14px 24px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      gap:14px;
      padding:10px 14px;
      border-radius:18px;
      background:linear-gradient(180deg,#000000d0,#00000090);
      border:1px solid var(--stroke);
      box-shadow:0 14px 40px #00000066;
    }

    .logo{
      width:90px;
      height:auto;
      flex:0 0 auto;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.7));
    }

    .titleBox{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      padding:8px 0;
      text-align:center;
    }

    .title{
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:clamp(20px, 5.2vw, 46px);
      color:var(--cyan);
      text-shadow:
        0 0 12px rgba(34,211,238,.55),
        0 0 28px rgba(34,211,238,.35),
        0 10px 30px rgba(0,0,0,.8);
      line-height:1.05;
    }

    /* Flecha animada apuntando a la columna de botones */
    .arrowHint{
      position:absolute;
      right:6px;
      top:50%;
      transform:translateY(-12px);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      pointer-events:none;
      opacity:.95;
    }
    .arrowText{
      font-size:12px;
      color:#ffffffb0;
      letter-spacing:.03em;
      display:none; /* sin texto, no subestimamos */
    }
    .arrow{
      width:0;height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-top:22px solid var(--red);
      filter: drop-shadow(0 0 10px rgba(225,6,0,.6));
      animation:bounce 1.1s infinite ease-in-out, blink 1.2s infinite linear;
    }
    @keyframes bounce{
      0%,100%{ transform:translateY(0); }
      50%{ transform:translateY(10px); }
    }
    @keyframes blink{
      0%,100%{ opacity:1; }
      50%{ opacity:.35; }
    }

    /* Lateral fijo RANKING ON */
    .side{
      position:fixed;
      left:10px;
      top:50%;
      transform:translateY(-50%);
      z-index:2;
      pointer-events:none;
      opacity:.9;
    }
    .side span{
      display:block;
      font-weight:900;
      letter-spacing:.12em;
      color:#fff;
      text-shadow:0 0 20px rgba(255,255,255,.18);
      font-size:clamp(26px, 4.4vw, 54px);
      writing-mode:vertical-rl;   /* vertical */
      transform:rotate(180deg);    /* se lee de abajo hacia arriba */
    }

    /* Footer url */
    .site{
      margin:14px auto 18px;
      text-align:center;
      font-weight:800;
      letter-spacing:.06em;
      color:#fff;
      opacity:.95;
      text-shadow:0 6px 22px rgba(0,0,0,.8);
    }

    /* Lista */
    #list{
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:10px 4px 24px;
    }

    .row{
      display:grid;
      grid-template-columns: 70px 66px 1fr 24px 140px; /* num, play, meta, indicador, votar */
      align-items:center;
      gap:12px;
      padding:18px 16px;
      border-radius:22px;
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid #ffffff12;
      box-shadow:0 18px 45px rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      overflow:hidden;
    }

    /* Top 1 destacado */
    .row.top1{
      border:1px solid rgba(225,6,0,.55);
      box-shadow:0 0 0 1px rgba(225,6,0,.20), 0 22px 60px rgba(225,6,0,.10), 0 22px 60px rgba(0,0,0,.55);
      position:relative;
    }
    .row.top1::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:24px;
      box-shadow:0 0 20px rgba(225,6,0,.45);
      pointer-events:none;
    }

    /* N√∫meros: intentamos usar Benjamin Gothic Heavy si existe, sino fallback fuerte */
    .rankNum{
      font-family: "Benjamin Gothic Heavy", "Impact", "Arial Black", system-ui, sans-serif;
      font-weight:900;
      font-size:44px;
      line-height:1;
      text-align:center;
      color:#fff;
      text-shadow:0 10px 22px rgba(0,0,0,.8);
    }
    .row.top1 .rankNum{
      color:var(--red);
      font-size:56px;
      filter: drop-shadow(0 0 10px rgba(225,6,0,.35));
    }

    .playBtn{
      width:56px;
      height:56px;
      border-radius:999px;
      border:2px solid #ffffffc0;
      background:transparent;
      color:#fff;
      display:grid;
      place-items:center;
      font-size:20px;
      cursor:pointer;
      transition:.15s ease;
      box-shadow:0 10px 25px rgba(0,0,0,.45);
    }
    .playBtn:hover{ transform:translateY(-1px); }
    .playBtn.isPlaying{
      border-color:#fff;
      color:#fff;
      box-shadow:0 0 0 2px rgba(225,6,0,.22), 0 12px 28px rgba(0,0,0,.55);
    }

    .meta{ min-width:0; }
    .song{
      font-weight:900;
      font-size:22px;
      line-height:1.05;
      margin-bottom:6px;
      color:#fff;
      text-shadow:0 8px 22px rgba(0,0,0,.75);
    }
    .artist{
      color:#ffffffb8;
      font-size:16px;
      line-height:1.15;
    }

    /* Indicador (tri√°ngulos reales) */
    .trend{
      width:0;height:0;
      justify-self:center;
      filter: drop-shadow(0 0 10px rgba(0,0,0,.5));
    }
    .trend.up{
      border-left:10px solid transparent;
      border-right:10px solid transparent;
      border-bottom:16px solid #22c55e; /* verde */
    }
    .trend.down{
      border-left:10px solid transparent;
      border-right:10px solid transparent;
      border-top:16px solid #ef4444; /* rojo */
    }
    .trend.stable{
      width:14px;height:14px;
      border-radius:3px;
      background:#facc15; /* amarillo */
    }

    .voteBtn{
      width:140px;
      height:50px;
      border-radius:16px;
      border:none;
      background:var(--red);
      color:#fff;
      font-weight:900;
      letter-spacing:.04em;
      cursor:pointer;
      box-shadow:0 14px 26px rgba(225,6,0,.25);
      transition:.15s ease;
    }
    .voteBtn:hover{ transform:translateY(-1px); }
    .voteBtn:disabled{
      background:#5a5a5a;
      cursor:not-allowed;
      box-shadow:none;
      opacity:.9;
    }

    /* Responsive */
    @media (max-width:720px){
      .logo{ width:76px; }
      .row{
        grid-template-columns: 64px 58px 1fr 22px 120px;
        padding:16px 14px;
      }
      .rankNum{ font-size:40px; }
      .row.top1 .rankNum{ font-size:52px; }
      .song{ font-size:20px; }
      .voteBtn{ width:120px; height:46px; border-radius:14px; }
      .side{ left:6px; }
    }
    @media (max-width:420px){
      .row{
        grid-template-columns: 58px 54px 1fr 20px 112px;
        gap:10px;
      }
      .song{ font-size:19px; }
      .artist{ font-size:15px; }
      .voteBtn{ width:112px; }
    }

    /* Mini debug opcional (apagado) */
    #diag{
      display:none;
    }
  </style>
</head>

<body>
  <div class="side"><span>RANKING ON</span></div>

  <div class="wrap">
    <div class="topbar">
      <img class="logo" src="logotipo.png" alt="ON Radio" />

      <div class="titleBox">
        <div class="title">VOT√Å TU TEMA<br/>PREFERIDO</div>

        <!-- flecha apuntando a los botones votar -->
        <div class="arrowHint" aria-hidden="true">
          <div class="arrow"></div>
        </div>
      </div>
    </div>

    <div class="site">www.laonradio.com.ar</div>

    <div id="list"></div>

    <div id="diag"></div>
  </div>

  <!-- Firebase compat (estable en GitHub Pages) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ========= CONFIG =========
    const firebaseConfig = {
      apiKey: "AIzaSyC8XXef5k8hLmNL8ufIJsc7Sx5KTlRFdH8",
      authDomain: "on-radio-ranking.firebaseapp.com",
      databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
      projectId: "on-radio-ranking",
      storageBucket: "on-radio-ranking.firebasestorage.app",
      messagingSenderId: "311635352358",
      appId: "1:311635352358:web:257ff4821987f07d31ffe7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const listEl = document.getElementById("list");

    // ========= VOTO 1 POR D√çA (TOTAL) =========
    function todayKey(){
      // fecha local AAAA-MM-DD
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return ${yyyy}-${mm}-${dd};
    }

    function alreadyVotedToday(){
      return localStorage.getItem("onradio_vote_date") === todayKey();
    }

    function markVoted(){
      localStorage.setItem("onradio_vote_date", todayKey());
    }

    // ========= AUDIO PLAY/PAUSE GLOBAL =========
    let currentAudio = null;
    let currentBtn = null;

    function setBtnPlay(btn){
      btn.textContent = "‚ñ∂";
      btn.classList.remove("isPlaying");
    }
    function setBtnPause(btn){
      btn.textContent = "‚è∏";
      btn.classList.add("isPlaying");
    }

    window.playAudio = function(src, btn){
      // si apret√≥ el mismo bot√≥n, toggle pause/play
      if(currentAudio && currentBtn === btn){
        if(currentAudio.paused){
          currentAudio.play();
          setBtnPause(btn);
        }else{
          currentAudio.pause();
          setBtnPlay(btn);
        }
        return;
      }

      // si hay otro sonando, lo paro
      if(currentAudio){
        currentAudio.pause();
        currentAudio = null;
      }
      if(currentBtn){
        setBtnPlay(currentBtn);
      }

      currentAudio = new Audio(src);
      currentBtn = btn;

      currentAudio.play().then(()=>{
        setBtnPause(btn);
      }).catch(()=>{
        alert("No se pudo reproducir el audio. Revis√° que el mp3 exista en el repo.");
        setBtnPlay(btn);
        currentAudio = null;
        currentBtn = null;
      });

      currentAudio.onended = () => {
        if(currentBtn) setBtnPlay(currentBtn);
        currentAudio = null;
        currentBtn = null;
      };
    };

    // ========= TENDENCIA REAL (sube/baja/igual) =========
    // Guardamos el ranking anterior en localStorage para comparar contra el nuevo ranking.
    function getPrevOrder(){
      try{
        return JSON.parse(localStorage.getItem("onradio_prev_order") || "[]");
      }catch{
        return [];
      }
    }
    function setPrevOrder(arr){
      localStorage.setItem("onradio_prev_order", JSON.stringify(arr));
    }
    function trendFor(id, newIndex, prevOrder){
      const prevIndex = prevOrder.indexOf(id);
      if(prevIndex === -1) return "stable"; // primera vez: estable
      if(newIndex < prevIndex) return "up";
      if(newIndex > prevIndex) return "down";
      return "stable";
    }

    // ========= VOTAR =========
    window.vote = function(id){
      if(alreadyVotedToday()){
        alert("Ya votaste hoy ‚úÖ\nVolv√© ma√±ana para votar de nuevo.");
        return;
      }

      const ref = db.ref("temas/" + id + "/votos");
      ref.transaction(current => (current || 0) + 1)
        .then(()=>{
          markVoted();
          alert("Gracias por votar en el Ranking ON üî•\nTu voto ya qued√≥ registrado.\nVolv√© ma√±ana para votar otra vez.");
        })
        .catch(()=>{
          alert("No se pudo registrar el voto. Revis√° reglas o conexi√≥n.");
        });
    };

    // ========= RENDER =========
    function render(items){
      listEl.innerHTML = "";

      const prevOrder = getPrevOrder();
      const newOrder = items.map(x => x.id);

      items.forEach((t, index) => {
        const row = document.createElement("div");
        row.className = "row" + (index === 0 ? " top1" : "");

        const tr = trendFor(t.id, index, prevOrder);
        const trendHtml = (tr === "stable")
          ? <div class="trend stable" title="Se mantiene"></div>
          : <div class="trend ${tr}" title="${tr === "up" ? "Subi√≥" : "Baj√≥"}"></div>;

        const disabled = alreadyVotedToday();

        row.innerHTML = `
          <div class="rankNum">${index + 1}</div>

          <button class="playBtn" type="button" onclick="playAudio('${t.audio}', this)" aria-label="Reproducir/Pausar">
            ‚ñ∂
          </button>

          <div class="meta">
            <div class="song">${escapeHtml(t.nombre || "")}</div>
            <div class="artist">${escapeHtml(t.artista || "")}</div>
          </div>

          ${trendHtml}

          <div class="voteWrap">
            <button class="voteBtn" type="button" onclick="vote('${t.id}')" ${disabled ? "disabled" : ""}>
              ${disabled ? "YA VOTASTE" : "VOTAR"}
            </button>
          </div>
        `;

        listEl.appendChild(row);
      });

      setPrevOrder(newOrder);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    // ========= Firebase LIVE =========
    db.ref("temas").on("value", snapshot => {
      const data = snapshot.val();

      if(!data){
        listEl.innerHTML = "<div style='color:#fff;padding:12px'>No hay temas cargados en /temas</div>";
        return;
      }

      const items = Object.keys(data).map(key => ({
        id: key,
        ...data[key]
      }));

      // Orden real por votos
      items.sort((a,b) => (b.votos || 0) - (a.votos || 0));

      render(items);
    }, err => {
      listEl.innerHTML = "<div style='color:#fff;padding:12px'>Error leyendo Firebase.</div>";
      console.error(err);
    });
  </script>
</body>
</html>
