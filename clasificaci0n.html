<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ranking ON Radio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: url('fondoranking.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }
    .logo {
      display: block;
      margin: 20px auto;
      width: 180px; /* mismo tamaño que index.html */
    }
    h1 {
      text-align: center;
      font-size: 2em;
      font-weight: bold;
      margin: 10px 0 30px 0;
    }
    .tema {
      display: flex;
      align-items: center;
      background: rgba(0,0,0,0.5);
      margin: 10px 20px;
      padding: 10px;
      border-radius: 8px;
      flex-wrap: wrap;
    }
    .tema img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      margin-right: 15px;
    }
    .info {
      flex: 1 1 200px;
      min-width: 150px;
    }
    .info b {
      display: block;
      font-size: 1.1em;
    }
    audio {
      flex: 1 1 250px;
      max-width: 300px;
      margin-right: 10px;
      margin-top: 5px;
      margin-bottom: 5px;
    }
    button.votar {
      background-color: red;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 1em;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 5px;
      height: 40px;
    }
    footer {
      background: rgba(0,0,0,0.6);
      text-align: center;
      padding: 15px 10px;
      font-size: 0.9em;
      position: fixed;
      width: 100%;
      bottom: 0;
    }
    @media (max-width: 600px) {
      .tema {
        flex-direction: column;
        align-items: flex-start;
      }
      audio {
        width: 100%;
        max-width: 100%;
        margin-right: 0;
      }
      button.votar {
        width: 100%;
        margin-top: 5px;
      }
    }
  </style>
</head>
<body>

<img src="logotipo.png" class="logo" alt="ON Radio Logo">
<h1>Votá en el Ranking ON</h1>

<div id="temas-container"></div>

<footer>
  <div>Derechos reservados a ON Radio</div>
  <div>Dale ON a la música que más te gusta!</div>
</footer>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getDatabase, ref, get, child, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC8XXef5k8hLmNL8ufIJsc7Sx5KTlRFdH8",
    authDomain: "on-radio-ranking.firebaseapp.com",
    databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
    projectId: "on-radio-ranking",
    storageBucket: "on-radio-ranking.firebasestorage.app",
    messagingSenderId: "311635352358",
    appId: "1:311635352358:web:257ff4821987f07d31ffe7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const temasRef = ref(db, 'temas');

  function cargarTemas(temas) {
    const container = document.getElementById('temas-container');
    container.innerHTML = '';

    // Mezclar aleatoriamente
    const keys = Object.keys(temas);
    keys.sort(() => Math.random() - 0.5);

    keys.forEach(key => {
      const t = temas[key];
      const temaDiv = document.createElement('div');
      temaDiv.className = 'tema';

      temaDiv.innerHTML = `
        <img src="${t.imagen}" alt="${t.nombre}">
        <div class="info">
          <b>${t.nombre}</b>
          <span>${t.artista}</span>
        </div>
        <audio controls src="${t.audio}"></audio>
        <button class="votar">Votar</button>
      `;

      const votarBtn = temaDiv.querySelector('.votar');
      votarBtn.addEventListener('click', () => {
        if (!localStorage.getItem('voto_' + key)) {
          // Sumar un voto
          const votosRef = ref(db, temas/${key}/votos);
          get(votosRef).then(snapshot => {
            const current = snapshot.val() || 0;
            update(ref(db, temas/${key}), { votos: current + 1 }).then(() => {
              alert("Gracias por votar tu tema preferido.\nRecordá que podés votar una sola vez por día.\nVolvé mañana para votar otra vez.");
              localStorage.setItem('voto_' + key, 'true');
              // refrescar ranking si se quiere, acá recarga la lista
              get(child(ref(db), 'temas')).then(snapshot => {
                cargarTemas(snapshot.val());
              });
            });
          });
        } else {
          alert("Ya votaste este tema hoy. Volvé mañana para votar otra vez.");
        }
      });

      container.appendChild(temaDiv);
    });
  }

  // Cargar temas desde Firebase al iniciar
  get(temasRef).then(snapshot => {
    if (snapshot.exists()) {
      cargarTemas(snapshot.val());
    } else {
      console.log("No hay temas cargados");
    }
  }).catch(error => console.error(error));
</script>

</body>
</html>
