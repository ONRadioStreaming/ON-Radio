<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ranking ON</title>

  <!-- Tipografías (fallback si Benjamin Gothic Heavy no existe en el dispositivo) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #000;
      --card: rgba(0,0,0,.46);
      --card2: rgba(0,0,0,.36);
      --stroke: rgba(255,255,255,.08);
      --white: #fff;
      --muted: rgba(255,255,255,.78);
      --muted2: rgba(255,255,255,.58);
      --red: #e10000;
      --red2:#ff2b2b;
      --cyan: #27d6e7;
      --yellow:#f6c100;
      --green:#39d353;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--white);
      background: var(--bg);
      overflow-x:hidden;
    }

    /* Fondo */
    .bg{
      position: fixed;
      inset:0;
      background:
        linear-gradient(to bottom, rgba(0,0,0,.52), rgba(0,0,0,.70)),
        url("fondoranking2.jpg");
      background-size: cover;
      background-position: center;
      filter: saturate(1.05) contrast(1.05);
      z-index:-2;
    }
    .vignette{
      position: fixed;
      inset:0;
      background: radial-gradient(circle at center, rgba(0,0,0,.10), rgba(0,0,0,.80));
      z-index:-1;
      pointer-events:none;
    }

    /* Lateral fijo RANKING ON */
    .rank-fixed{
      position: fixed;
      left: 10px;
      top: 50%;
      transform: translateY(-50%) rotate(180deg);
      writing-mode: vertical-rl;
      z-index: 10;
      pointer-events:none;
      user-select:none;

      font-family: Anton, sans-serif;
      font-size: clamp(30px, 4.2vw, 66px);
      letter-spacing: 8px;
      color: #fff;
      opacity: .20;
      text-transform: uppercase;
      text-shadow: 0 0 18px rgba(255,255,255,.12);
    }

    /* Contenedor principal */
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 16px 28px;
    }

    /* Header */
    .header{
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px 0 18px;
      margin-left: 70px;  /* deja respirar al RANKING ON fijo */
    }

    .logo{
      position:absolute;
      right: 0;
      top: 4px;
      width: 92px;
      height: auto;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.55));
      opacity: .95;
    }

    .titleBox{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
    }

    .title{
      text-align:center;
      font-family: Anton, sans-serif;
      text-transform: uppercase;
      letter-spacing: 3px;
      font-size: clamp(26px, 4.4vw, 44px);
      color: var(--cyan);
      text-shadow:
        0 0 10px rgba(39,214,231,.35),
        0 0 22px rgba(39,214,231,.22);
      margin:0;
      line-height:1.05;
    }

    .arrowToVotes{
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right:10px solid transparent;
      border-top: 16px solid var(--cyan);
      filter: drop-shadow(0 0 10px rgba(39,214,231,.35));
      opacity: .95;
      margin-left: auto;
      margin-right: 110px; /* lo corre hacia la columna de VOTAR */
    }

    /* Lista */
    .list{
      margin-left: 70px;  /* deja respirar al RANKING ON fijo */
      display:flex;
      flex-direction:column;
      gap: 14px;
      padding-bottom: 18px;
    }

    /* Fila: num | play | info | trend | votar */
    .row{
      display:grid;
      grid-template-columns: 64px 56px 1fr 22px 120px;
      align-items:center;
      column-gap: 12px;

      padding: 14px 14px;
      border-radius: 18px;
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: 0 16px 34px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }

    .row.isTop1{
      border-color: rgba(255,43,43,.35);
      box-shadow:
        0 18px 40px rgba(0,0,0,.45),
        0 0 0 1px rgba(255,43,43,.18) inset;
      background: linear-gradient(to right, rgba(255,43,43,.12), rgba(0,0,0,.46));
    }

    .rankNum{
      font-family: "Benjamin Gothic Heavy", Anton, Impact, system-ui, sans-serif;
      font-weight: 800;
      font-size: 44px;
      line-height:1;
      color: #fff;
      text-align:center;
      text-shadow: 0 10px 30px rgba(0,0,0,.55);
    }
    .row.isTop1 .rankNum{
      color: var(--red2);
      font-size: 54px;
    }

    .playBtn{
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.75);
      background: rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease;
      user-select:none;
    }
    .playBtn:active{ transform: scale(.98); }
    .playBtn svg{
      width: 18px;
      height: 18px;
      fill: #fff;
      opacity: .95;
      margin-left: 2px; /* hace el play más centrado visualmente */
    }
    .row.isPlaying .playBtn{
      border-color: rgba(39,214,231,.95);
      box-shadow: 0 0 18px rgba(39,214,231,.18);
    }

    .info{
      min-width:0;
    }
    .song{
      font-weight: 800;
      font-size: 20px;
      color: #fff;
      line-height: 1.05;
      margin:0 0 5px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .artist{
      margin:0;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .trend{
      width: 18px;
      height: 18px;
      justify-self:center;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .trend.up{
      width:0;height:0;
      border-left: 9px solid transparent;
      border-right:9px solid transparent;
      border-bottom: 16px solid var(--green);
      filter: drop-shadow(0 0 10px rgba(57,211,83,.22));
    }
    .trend.down{
      width:0;height:0;
      border-left: 9px solid transparent;
      border-right:9px solid transparent;
      border-top: 16px solid var(--red2);
      filter: drop-shadow(0 0 10px rgba(255,43,43,.20));
    }
    .trend.stable{
      width: 14px;
      height: 14px;
      background: var(--yellow);
      border-radius: 4px;
      filter: drop-shadow(0 0 10px rgba(246,193,0,.18));
    }

    .voteBtn{
      justify-self:end;
      width: 120px;
      height: 46px;
      border:0;
      border-radius: 14px;
      background: var(--red);
      color: #fff;
      font-weight: 900;
      letter-spacing: .6px;
      cursor:pointer;
      box-shadow: 0 14px 26px rgba(0,0,0,.35);
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
    }
    .voteBtn:active{ transform: scale(.99); }
    .voteBtn[disabled]{
      opacity: .45;
      cursor:not-allowed;
      filter: grayscale(.25);
    }

    /* Footer */
    .footer{
      margin-left: 70px;
      text-align:center;
      padding: 10px 0 2px;
      color: rgba(255,255,255,.78);
      font-weight: 700;
      letter-spacing: .6px;
      text-shadow: 0 10px 26px rgba(0,0,0,.45);
    }

    /* Mensajes */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.82);
      border: 1px solid rgba(255,255,255,.14);
      color: #fff;
      padding: 12px 14px;
      border-radius: 14px;
      max-width: min(620px, calc(100vw - 28px));
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
      font-size: 14px;
      line-height:1.25;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-6px);
    }

    /* Responsive */
    @media (max-width: 520px){
      .header, .list, .footer{ margin-left: 62px; }
      .logo{ width: 72px; top: 6px; }
      .arrowToVotes{ margin-right: 92px; }
      .row{
        grid-template-columns: 54px 52px 1fr 20px 104px;
        padding: 12px 12px;
        column-gap: 10px;
      }
      .rankNum{ font-size: 40px; }
      .row.isTop1 .rankNum{ font-size: 50px; }
      .song{ font-size: 18px; }
      .voteBtn{ width: 104px; height: 44px; }
      .playBtn{ width: 44px; height: 44px; }
    }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="vignette"></div>

  <div class="rank-fixed">RANKING&nbsp;ON</div>

  <div class="wrap">
    <header class="header">
      <div class="titleBox">
        <h1 class="title">VOTÁ TU TEMA PREFERIDO</h1>
        <div class="arrowToVotes" aria-hidden="true"></div>
      </div>
      <img class="logo" src="logotipo.png" alt="ON Radio Streaming">
    </header>

    <main class="list" id="list">
      <!-- filas dinámicas -->
    </main>

    <footer class="footer">www.laonradio.com.ar</footer>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import {
      getDatabase, ref, onValue, get, update, runTransaction
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    // ✅ TU CONFIG (la tuya)
    const firebaseConfig = {
      apiKey: "AIzaSyC8XXef5k8hLmNL8ufIJsc7Sx5KTlRFdH8",
      authDomain: "on-radio-ranking.firebaseapp.com",
      databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
      projectId: "on-radio-ranking",
      storageBucket: "on-radio-ranking.firebasestorage.app",
      messagingSenderId: "311635352358",
      appId: "1:311635352358:web:257ff4821987f07d31ffe7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const temasRef = ref(db, "temas");
    const posicionesRef = ref(db, "posiciones"); // { temaId: posicion }
    const listEl = document.getElementById("list");
    const toastEl = document.getElementById("toast");

    // Player único para toda la página
    const audio = new Audio();
    audio.preload = "metadata";
    let playingId = null;

    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toastEl.classList.remove("show"), 3200);
    }

    function todayKey(){
      // 1 voto por día TOTAL (por dispositivo/navegador)
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function hasVotedToday(){
      return localStorage.getItem("onradio_voted_day") === todayKey();
    }

    function lockVotingToday(){
      localStorage.setItem("onradio_voted_day", todayKey());
    }

    function safeUrl(file){
      // Para que no se rompa si hay espacios/acentos (por las dudas)
      return encodeURI(file);
    }

    function playIconSvg(){
      return `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M8 5v14l11-7z"></path>
        </svg>
      `;
    }

    function pauseIconSvg(){
      return `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 5h4v14H6zM14 5h4v14h-4z"></path>
        </svg>
      `;
    }

    function setRowPlayingState(rowEl, isPlaying){
      rowEl.classList.toggle("isPlaying", isPlaying);
      const btn = rowEl.querySelector(".playBtn");
      if(!btn) return;
      btn.innerHTML = isPlaying ? pauseIconSvg() : playIconSvg();
    }

    async function togglePlay(temaId, audioFile, rowEl){
      try{
        const src = safeUrl(audioFile);
        if(playingId === temaId){
          if(!audio.paused){
            audio.pause();
            setRowPlayingState(rowEl, false);
          }else{
            await audio.play();
            setRowPlayingState(rowEl, true);
          }
          return;
        }

        // Cambia de tema
        // Apaga el anterior
        if(playingId){
          const prev = document.querySelector(\`.row[data-id="\${playingId}"]\`);
          if(prev) setRowPlayingState(prev, false);
        }

        playingId = temaId;
        audio.src = src;
        await audio.play();
        setRowPlayingState(rowEl, true);

      }catch(err){
        console.error(err);
        showToast("No pude reproducir el audio. Revisá que el MP3 exista en el repo y el nombre coincida.");
      }
    }

    audio.addEventListener("ended", ()=>{
      if(playingId){
        const row = document.querySelector(\`.row[data-id="\${playingId}"]\`);
        if(row) setRowPlayingState(row, false);
      }
      playingId = null;
    });

    function buildTrendClass(prevPos, newPos){
      if(prevPos == null) return "stable";
      if(newPos < prevPos) return "up";
      if(newPos > prevPos) return "down";
      return "stable";
    }

    function render(temasObj, posicionesObj){
      // temasObj: {id:{nombre, artista, audio, votos}}
      const temasArr = Object.entries(temasObj || {}).map(([id, t]) => ({
        id,
        nombre: t?.nombre ?? id,
        artista: t?.artista ?? "",
        audio: t?.audio ?? "",
        votos: Number(t?.votos ?? 0)
      }));

      // Orden real: votos desc, y luego nombre asc para desempatar estable
      temasArr.sort((a,b)=>{
        if(b.votos !== a.votos) return b.votos - a.votos;
        return (a.nombre || "").localeCompare(b.nombre || "", "es");
      });

      listEl.innerHTML = "";

      const votedToday = hasVotedToday();

      temasArr.forEach((t, idx)=>{
        const pos = idx + 1;
        const prevPos = posicionesObj?.[t.id] ?? null;
        const trend = buildTrendClass(prevPos, pos);

        const row = document.createElement("div");
        row.className = "row" + (pos === 1 ? " isTop1" : "");
        row.dataset.id = t.id;

        row.innerHTML = `
          <div class="rankNum">${pos}</div>

          <button class="playBtn" type="button" aria-label="Reproducir">
            ${playIconSvg()}
          </button>

          <div class="info">
            <p class="song">${escapeHtml(t.nombre)}</p>
            <p class="artist">${escapeHtml(t.artista)}</p>
          </div>

          <div class="trend ${trend}" aria-label="${trend}"></div>

          <button class="voteBtn" type="button" ${votedToday ? "disabled" : ""}>
            VOTAR
          </button>
        `;

        const playBtn = row.querySelector(".playBtn");
        playBtn.addEventListener("click", ()=> togglePlay(t.id, t.audio, row));

        const voteBtn = row.querySelector(".voteBtn");
        voteBtn.addEventListener("click", async ()=>{
          if(hasVotedToday()){
            showToast("Ya votaste hoy. Volvé mañana para votar otra vez.");
            return;
          }

          try{
            // 1) suma voto (transacción)
            const vRef = ref(db, `temas/${t.id}/votos`);
            await runTransaction(vRef, (cur)=> (Number(cur || 0) + 1));

            // 2) bloquea el voto por hoy (TOTAL)
            lockVotingToday();

            // 3) deshabilita todos los botones
            document.querySelectorAll(".voteBtn").forEach(b=> b.disabled = true);

            showToast("Gracias por votar tu tema preferido. Recordá que podés votar una sola vez por día. Volvé mañana para votar otra vez.");

          }catch(err){
            console.error(err);
            showToast("Error al votar. Probá de nuevo en unos segundos.");
          }
        });

        listEl.appendChild(row);
      });
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function syncPosiciones(temasObj){
      // Calcula posiciones actuales y guarda en /posiciones para flechas reales en próximos renders
      const temasArr = Object.entries(temasObj || {}).map(([id, t]) => ({
        id,
        votos: Number(t?.votos ?? 0),
        nombre: t?.nombre ?? id
      }));
      temasArr.sort((a,b)=>{
        if(b.votos !== a.votos) return b.votos - a.votos;
        return (a.nombre || "").localeCompare(b.nombre || "", "es");
      });

      const newPos = {};
      temasArr.forEach((t, i)=> newPos[t.id] = i + 1);

      // Update simple (última visita define baseline). Es suficiente para las flechas "reales" por ranking.
      try{
        await update(ref(db), { posiciones: newPos });
      }catch(e){
        // si falla no rompe la app, solo no actualiza flechas
        console.warn("No pude actualizar posiciones:", e);
      }
    }

    // Carga inicial y realtime
    onValue(temasRef, async (snap)=>{
      const temasObj = snap.val() || {};

      // Trae posiciones actuales guardadas
      let posicionesObj = {};
      try{
        const pSnap = await get(posicionesRef);
        posicionesObj = pSnap.val() || {};
      }catch(e){
        posicionesObj = {};
      }

      render(temasObj, posicionesObj);

      // Actualiza posiciones para flechas en base a ranking real
      await syncPosiciones(temasObj);
    });
  </script>
</body>
</html>
