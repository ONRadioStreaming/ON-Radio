<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ranking ON</title>

  <style>
    :root{
      --cyan:#18e0ff;
      --red:#e60000;
      --glass: rgba(0,0,0,.45);
      --text:#ffffff;
      --muted: rgba(255,255,255,.78);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      color: var(--text);
      background:#000 url("fondoranking2.jpg") center/cover no-repeat fixed;
    }

    .wrap{ min-height:100vh; display:flex; flex-direction:column; }

    /* Diagnóstico */
    .diag{
      position:fixed;
      top:10px;
      left:10px;
      z-index:9999;
      max-width:min(520px, calc(100vw - 20px));
      background:rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.15);
      border-radius:10px;
      padding:10px 12px;
      font-size:12px;
      line-height:1.25;
      backdrop-filter: blur(4px);
      display:none;
      white-space:pre-wrap;
    }
    .diag.show{ display:block; }
    .diag b{ color: var(--cyan); }

    .topbar{
      position: sticky; top: 0; z-index: 10;
      padding: 16px 14px 8px;
      background: linear-gradient(to bottom, rgba(0,0,0,.65), rgba(0,0,0,0));
      backdrop-filter: blur(2px);
    }
    .toprow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .titlebox{ flex:1 1 auto; text-align:center; }
    .title{
      font-weight:900; letter-spacing:2px; text-transform:uppercase;
      color: var(--cyan);
      text-shadow: 0 0 10px rgba(24,224,255,.35), 0 0 20px rgba(24,224,255,.22);
      font-size: clamp(22px, 4.2vw, 46px);
      margin:0;
    }

    /* Flecha: a la columna de VOTAR */
    .arrow-row{
      display:flex;
      justify-content:flex-end;
      padding-right: 24px;
      margin-top: 6px;
    }
    .arrow{
      width:0;height:0;
      border-left:10px solid transparent;
      border-right:10px solid transparent;
      border-top:18px solid var(--cyan);
      filter: drop-shadow(0 0 8px rgba(24,224,255,.35));
      opacity:.95;
    }

    .logo{
      width:86px; height:auto;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,.6));
      flex:0 0 auto;
    }

    /* Ranking vertical */
    .side-ranking{
      position: fixed;
      left: 10px;
      top: 150px;
      writing-mode: vertical-rl;
      transform: rotate(180deg);
      font-weight: 900;
      letter-spacing: 2px;
      color: rgba(24,224,255,.55);
      text-shadow: 0 0 12px rgba(24,224,255,.22);
      user-select:none;
      pointer-events:none;
      font-size: 28px;
    }

    .list{
      width: min(1100px, 100%);
      margin: 0 auto;
      padding: 10px 12px 90px;
    }

    .row{
      display:grid;
      grid-template-columns: 64px 54px 1fr 28px 108px;
      gap: 10px;
      align-items:center;
      padding: 12px 12px;
      margin: 10px 0;
      background: var(--glass);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .row.top1{
      background: linear-gradient(90deg, rgba(230,0,0,.22), rgba(0,0,0,.48));
      border-color: rgba(230,0,0,.25);
    }

    /* Número con “cuerpo” (si la tipografía no existe, cae a Arial Black) */
    @font-face{
      font-family: "Benjamin Gothic Heavy";
      src: local("Benjamin Gothic Heavy");
      font-display: swap;
    }
    .pos{
      text-align:center;
      font-family: "Benjamin Gothic Heavy", "Arial Black", Arial, sans-serif;
      font-weight:900;
      font-size: 28px;
      color:#fff;
      line-height:1;
    }
    .top1 .pos{
      color: var(--red);
      font-size: 38px;
      text-shadow: 0 0 10px rgba(230,0,0,.35);
    }

    .playbtn{
      width: 44px; height: 44px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.45);
      background: rgba(0,0,0,.2);
      display:grid; place-items:center;
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease;
      user-select:none;
    }
    .playbtn:hover{ transform: scale(1.03); border-color: rgba(24,224,255,.7); }
    .playicon{
      width:0;height:0;
      border-left: 12px solid rgba(255,255,255,.92);
      border-top: 7px solid transparent;
      border-bottom: 7px solid transparent;
      margin-left:2px;
    }
    .pauseicon{ width:14px;height:14px; display:flex; gap:4px; }
    .pauseicon span{ width:5px;height:14px; background: rgba(255,255,255,.92); display:block; }

    .meta .song{ font-weight:900; font-size:16px; }
    .meta .artist{ font-size:13px; color: var(--muted); margin-top:4px; }

    .trend{ display:flex; justify-content:center; align-items:center; height:24px; }
    .tri-up{
      width:0;height:0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 14px solid #33ff66;
      filter: drop-shadow(0 0 6px rgba(51,255,102,.25));
    }
    .tri-down{
      width:0;height:0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 14px solid #ff3b3b;
      filter: drop-shadow(0 0 6px rgba(255,59,59,.25));
    }
    .sq-stable{
      width:12px;height:12px;
      background:#ffd500;
      border-radius:3px;
      filter: drop-shadow(0 0 6px rgba(255,213,0,.25));
    }

    .vote{
      justify-self:end;
      width:108px; height:40px;
      border-radius:10px;
      border:0;
      background: var(--red);
      color:#fff;
      font-weight: 900;
      letter-spacing: 1px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(230,0,0,.25);
    }
    .vote:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .footer{
      margin-top:auto;
      padding: 12px 12px 16px;
      text-align:center;
      background: linear-gradient(to top, rgba(0,0,0,.65), rgba(0,0,0,0));
      color: rgba(255,255,255,.85);
      font-weight: 800;
      letter-spacing: .5px;
    }

    @media (max-width: 520px){
      .logo{ width:72px; }
      .row{ grid-template-columns: 56px 50px 1fr 26px 96px; padding:10px; }
      .vote{ width:96px; }
      .side-ranking{ font-size: 22px; top: 135px; }
      .arrow-row{ padding-right: 14px; }
    }
  </style>
</head>

<body>
  <div id="diag" class="diag"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="toprow">
        <div class="titlebox">
          <h1 class="title">VOTÁ TU TEMA PREFERIDO</h1>
          <div class="arrow-row"><div class="arrow" title="Votá acá abajo"></div></div>
        </div>
        <img class="logo" src="logotipo.png" alt="ON Radio">
      </div>
    </div>

    <div class="side-ranking">RANKING ON</div>

    <main class="list" id="lista"></main>

    <footer class="footer">www.laonradio.com.ar</footer>
  </div>

  <!-- Firebase compat (sin módulos) -->
  <script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.9.0/firebase-database-compat.js"></script>

  <script>
    const diag = document.getElementById("diag");
    function logDiag(msg){
      diag.classList.add("show");
      diag.textContent += msg + "\n";
    }

    // Anti-cache (para que GitHub Pages no te muestre “lo viejo”)
    const CACHE_BUSTER = Date.now();

    // 1 voto por día TOTAL (no por tema)
    const LS_KEY_DATE  = "onradio_vote_date";
    const LS_KEY_TRACK = "onradio_vote_track";

    function todayKey(){
      const d = new Date();
      return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
    }
    function hasVotedToday(){ return localStorage.getItem(LS_KEY_DATE) === todayKey(); }
    function setVoted(trackId){
      localStorage.setItem(LS_KEY_DATE, todayKey());
      localStorage.setItem(LS_KEY_TRACK, trackId);
    }

    // Tu config
    const firebaseConfig = {
      apiKey: "AIzaSyC8XXef5k8hLmNL8ufIJsc7Sx5KTlRFdH8",
      authDomain: "on-radio-ranking.firebaseapp.com",
      databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
      projectId: "on-radio-ranking",
      storageBucket: "on-radio-ranking.firebasestorage.app",
      messagingSenderId: "311635352358",
      appId: "1:311635352358:web:257ff4821987f07d31ffe7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const listaEl = document.getElementById("lista");

    // Audio: uno a la vez
    let currentAudio = null;
    let currentReset = null;

    function trendIcon(pos){
      // placeholder visual (después lo hacemos real con histórico si querés)
      if (pos % 3 === 1) return "up";
      if (pos % 3 === 2) return "down";
      return "stable";
    }

    function makeTrendEl(kind){
      const d = document.createElement("div");
      d.className = "trend";
      if(kind === "up"){
        const x = document.createElement("div"); x.className = "tri-up"; d.appendChild(x);
      } else if(kind === "down"){
        const x = document.createElement("div"); x.className = "tri-down"; d.appendChild(x);
      } else {
        const x = document.createElement("div"); x.className = "sq-stable"; d.appendChild(x);
      }
      return d;
    }

    function normalizeTema(id, t){
      return {
        id,
        nombre: String(t && t.nombre ? t.nombre : id),
        artista: String(t && t.artista ? t.artista : ""),
        audio: String(t && t.audio ? t.audio : ""),
        votos: Number(t && t.votos != null ? t.votos : 0)
      };
    }

    async function loadTemasSmart(){
      // Intento 1: /temas
      const snapTemas = await db.ref("temas").get();
      if (snapTemas.exists()) {
        const v = snapTemas.val();
        if (v && typeof v === "object" && Object.keys(v).length) {
          return { basePath: "temas", data: v };
        }
      }

      // Intento 2: raíz
      const snapRoot = await db.ref("/").get();
      if (snapRoot.exists()) {
        const v = snapRoot.val();
        const filtered = {};
        if (v && typeof v === "object") {
          for (const k in v) {
            const val = v[k];
            if (val && typeof val === "object" && ("audio" in val) && ("nombre" in val || "artista" in val)) {
              filtered[k] = val;
            }
          }
        }
        if (Object.keys(filtered).length) return { basePath: "", data: filtered };
      }

      return { basePath: "temas", data: {} };
    }

    function render(temas, basePath){
      listaEl.innerHTML = "";

      temas.sort((a,b) => b.votos - a.votos);

      const voted = hasVotedToday();

      temas.forEach((t, idx) => {
        const pos = idx + 1;

        const row = document.createElement("div");
        row.className = "row" + (pos === 1 ? " top1" : "");

        const posEl = document.createElement("div");
        posEl.className = "pos";
        posEl.textContent = String(pos);

        const playBtn = document.createElement("div");
        playBtn.className = "playbtn";
        playBtn.setAttribute("role","button");
        playBtn.setAttribute("aria-label","Reproducir");

        const playIcon = document.createElement("div");
        playIcon.className = "playicon";
        playBtn.appendChild(playIcon);

        const audio = new Audio(`${t.audio}?v=${CACHE_BUSTER}`);
        audio.preload = "none";

        function setPlayState(isPlaying){
          playBtn.innerHTML = "";
          if(isPlaying){
            const p = document.createElement("div");
            p.className = "pauseicon";
            p.innerHTML = "<span></span><span></span>";
            playBtn.appendChild(p);
          } else {
            const pi = document.createElement("div");
            pi.className = "playicon";
            playBtn.appendChild(pi);
          }
        }

        playBtn.addEventListener("click", async () => {
          if(currentAudio && currentAudio !== audio){
            currentAudio.pause();
            currentAudio.currentTime = 0;
            if(currentReset) currentReset();
          }
          if(audio.paused){
            try{
              await audio.play();
              currentAudio = audio;
              currentReset = () => setPlayState(false);
              setPlayState(true);
            }catch(e){
              alert("No pude reproducir el audio. Revisá que el .mp3 exista con ese nombre exacto en GitHub.");
            }
          } else {
            audio.pause();
            audio.currentTime = 0;
            setPlayState(false);
          }
        });
        audio.addEventListener("ended", () => setPlayState(false));

        const meta = document.createElement("div");
        meta.className = "meta";
        const song = document.createElement("div");
        song.className = "song";
        song.textContent = t.nombre;
        const artist = document.createElement("div");
        artist.className = "artist";
        artist.textContent = t.artista;
        meta.appendChild(song);
        meta.appendChild(artist);

        const trend = makeTrendEl(trendIcon(pos));

        const voteBtn = document.createElement("button");
        voteBtn.className = "vote";
        voteBtn.textContent = voted ? "VOTADO" : "VOTAR";
        voteBtn.disabled = voted;

        voteBtn.addEventListener("click", async () => {
          if(hasVotedToday()){
            alert("Gracias por votar tu tema preferido. Recordá que podés votar una sola vez por día. Volvé mañana para votar otra vez.");
            return;
          }
          const path = basePath ? `${basePath}/${t.id}/votos` : `${t.id}/votos`;

          try{
            await db.ref(path).transaction((current) => {
              const n = Number(current || 0);
              return n + 1;
            });

            setVoted(t.id);
            alert("Gracias por votar tu tema preferido. Recordá que podés votar una sola vez por día. Volvé mañana para votar otra vez.");
            boot(); // re-ordenar por votos
          }catch(e){
            alert("No pude registrar el voto. Revisá las reglas de Firebase o conexión.");
            logDiag("ERROR VOTO: " + (e && e.message ? e.message : String(e)));
          }
        });

        row.appendChild(posEl);
        row.appendChild(playBtn);
        row.appendChild(meta);
        row.appendChild(trend);
        row.appendChild(voteBtn);

        listaEl.appendChild(row);
      });
    }

    async function boot(){
      diag.textContent = "";
      logDiag("DIAG: arrancando…");
      try{
        logDiag("Firebase DB URL: " + firebaseConfig.databaseURL);

        const { basePath, data } = await loadTemasSmart();

        const keys = data ? Object.keys(data) : [];
        logDiag("Nodo detectado: " + (basePath ? "/" + basePath : "/(raíz)"));
        logDiag("Cantidad de temas: " + keys.length);

        if(!keys.length){
          logDiag("⚠️ No hay datos para renderizar. Revisá que exista /temas en Firebase.");
          listaEl.innerHTML = `<div style="padding:16px;background:rgba(0,0,0,.55);border-radius:12px;border:1px solid rgba(255,255,255,.12)">
            No se encontró el nodo <b>temas</b> en Firebase o está vacío.
          </div>`;
          return;
        }

        const temas = keys.map(k => normalizeTema(k, data[k]));
        render(temas, basePath);

        logDiag("✅ Render OK. (Si no ves filas, hay error de CSS/HTML, no de Firebase).");
      }catch(e){
        logDiag("❌ ERROR GENERAL: " + (e && e.message ? e.message : String(e)));
        listaEl.innerHTML = `<div style="padding:16px;background:rgba(0,0,0,.55);border-radius:12px">
          Error cargando ranking. Mirá el panel DIAG arriba.
        </div>`;
      }
    }

    boot();
  </script>
</body>
</html>
