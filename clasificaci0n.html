<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ranking ON</title>

  <!-- ===== Estilos ===== -->
  <style>
    :root{
      --cyan:#18d7ff;
      --red:#e40000;
      --card:#0a0a0acc;
      --card2:#0a0a0a99;
      --white:#ffffff;
      --muted:#cfcfcf;
      --shadow: 0 12px 30px rgba(0,0,0,.55);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--white);
      min-height:100vh;
      background:
        radial-gradient(circle at 20% 10%, rgba(255,0,0,.10), transparent 40%),
        radial-gradient(circle at 70% 40%, rgba(24,215,255,.10), transparent 40%),
        #000;
      overflow-x:hidden;
    }

    /* Fondo imagen (la carg√°s vos en el repo) */
    .bg{
      position:fixed;
      inset:0;
      background:url("fondoranking2.jpg") center/cover no-repeat;
      filter: contrast(1.05) brightness(.85);
      z-index:-2;
    }
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,.55));
      z-index:-1;
    }

    /* Contenedor general */
    .wrap{
      width:min(1100px, 94vw);
      margin: 18px auto 40px;
      position:relative;
      padding-left: 64px; /* lugar para el RANKING ON sticky */
    }

    /* Header superior */
    .top{
      display:flex;
      align-items:center;
      gap:14px;
      padding: 14px 16px;
      border-radius: 26px;
      background: rgba(0,0,0,.55);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.06);
      position:relative;
    }
    .logo{
      width:84px; height:auto;
      flex:0 0 auto;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.6));
    }

    .titleBox{
      flex:1;
      text-align:center;
      line-height:1.0;
      padding-right: 68px; /* espacio para flecha derecha */
    }

    /* T√≠tulo LED moderno */
    .title{
      margin:0;
      font-weight: 900;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--cyan);
      font-size: clamp(26px, 4.5vw, 46px);
      text-shadow:
        0 0 6px rgba(24,215,255,.55),
        0 0 18px rgba(24,215,255,.35),
        0 0 34px rgba(24,215,255,.20);
    }

    /* Flecha animada apuntando ‚Äúzona votar‚Äù */
    .arrowHint{
      position:absolute;
      right:18px;
      top: 50%;
      transform: translateY(-8px);
      width: 44px; height: 44px;
      display:grid; place-items:center;
      pointer-events:none;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.75));
    }
    .arrowHint::before{
      content:"";
      width:0;height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-top:22px solid var(--red);
      animation: bounce 1.1s infinite ease-in-out, blink 1.0s infinite linear;
    }
    @keyframes bounce{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(10px); }
    }
    @keyframes blink{
      0%,100%{ filter: brightness(1); opacity:1; }
      50%{ filter: brightness(1.6); opacity:.65; }
    }

    .footerSite{
      margin: 12px auto 0;
      text-align:center;
      font-weight: 800;
      letter-spacing: .8px;
      color:#fff;
      text-shadow: 0 6px 14px rgba(0,0,0,.85);
      font-size: clamp(16px, 2.8vw, 22px);
      opacity:.95;
    }

    /* RANKING ON sticky lateral (blanco, abajo->arriba) */
    .side{
      position:fixed;
      left: 10px;
      top: 54%;
      transform: translateY(-50%);
      z-index:10;
      pointer-events:none;
    }
    .sideText{
      writing-mode: vertical-rl;
      transform: rotate(180deg); /* lee de abajo hacia arriba */
      font-weight: 900;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: #fff;
      opacity: .90;
      font-size: clamp(20px, 3.8vw, 44px);
      text-shadow: 0 0 10px rgba(0,0,0,.8);
    }

    /* Lista */
    #list{
      margin-top: 18px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      padding-bottom: 36px;
    }

    /* Tarjeta de tema */
    .row{
      display:grid;
      grid-template-columns: 66px 62px 1fr 18px 132px;
      align-items:center;
      gap: 14px;
      padding: 14px 14px;
      border-radius: var(--radius);
      background: rgba(0,0,0,.60);
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      position:relative;
      overflow:hidden;
    }

    /* Marco LED rojo suave */
    .row::before{
      content:"";
      position:absolute; inset:0;
      border-radius: var(--radius);
      box-shadow: inset 0 0 0 1px rgba(255,0,0,.25), 0 0 16px rgba(255,0,0,.18);
      pointer-events:none;
      opacity:.85;
    }

    /* Puesto 1 destacado */
    .row.top1{
      background: rgba(80,0,0,.40);
      border: 1px solid rgba(255,0,0,.25);
    }
    .row.top1::before{
      box-shadow: inset 0 0 0 1px rgba(255,0,0,.45), 0 0 22px rgba(255,0,0,.28);
      opacity:1;
    }

    /* Numeraci√≥n (Benjamin Gothic Heavy si la sub√≠s; si no, fallback) */
    @font-face{
      font-family: "BenjaminGothicHeavy";
      src: url("benjamin-gothic-heavy.woff2") format("woff2");
      font-display: swap;
    }
    .num{
      font-family: "BenjaminGothicHeavy", "Arial Black", Impact, system-ui, sans-serif;
      font-weight: 900;
      text-align:center;
      line-height:1;
      color:#fff;
      font-size: 42px;
      text-shadow: 0 10px 18px rgba(0,0,0,.75);
    }
    .top1 .num{
      color: var(--red);
      font-size: 52px;
      text-shadow: 0 0 10px rgba(255,0,0,.35), 0 10px 18px rgba(0,0,0,.75);
    }

    /* Play */
    .playBtn{
      width: 54px; height: 54px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.85);
      display:grid; place-items:center;
      cursor:pointer;
      user-select:none;
      background: rgba(0,0,0,.25);
      transition: transform .08s ease, filter .12s ease, border-color .12s ease;
    }
    .playBtn:active{ transform: scale(.97); }
    .playIcon{
      width:0;height:0;
      border-left: 14px solid rgba(255,255,255,.95);
      border-top: 9px solid transparent;
      border-bottom: 9px solid transparent;
      margin-left: 3px;
    }
    .playBtn.playing{
      border-color: rgba(255,0,0,.95);
      filter: drop-shadow(0 0 10px rgba(255,0,0,.35));
    }
    .playBtn.playing .playIcon{
      /* icono PAUSA */
      width: 16px; height: 18px;
      border: none;
      margin-left: 0;
      background:
        linear-gradient(to right, rgba(255,255,255,.95) 0 6px, transparent 6px 10px, rgba(255,255,255,.95) 10px 16px);
    }

    .meta{ min-width:0; }
    .track{
      font-weight: 900;
      font-size: 20px;
      color:#fff;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .artist{
      margin:4px 0 0;
      color: var(--muted);
      font-size: 15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Indicador: ‚ñ≤ verde, ‚ñº rojo, ‚ñ† amarillo */
    .trend{
      width: 14px; height: 14px;
      display:inline-block;
      justify-self:center;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.7));
    }
    .trend.up{
      width:0;height:0;
      border-left:7px solid transparent;
      border-right:7px solid transparent;
      border-bottom:12px solid #2bff7a;
    }
    .trend.down{
      width:0;height:0;
      border-left:7px solid transparent;
      border-right:7px solid transparent;
      border-top:12px solid #ff2b2b;
    }
    .trend.same{
      background:#ffd000;
      border-radius:3px;
      box-shadow: 0 0 10px rgba(255,208,0,.25);
    }

    /* Bot√≥n votar */
    .voteBtn{
      justify-self:end;
      border:none;
      border-radius: 18px;
      padding: 14px 22px;
      font-weight: 900;
      letter-spacing: .6px;
      text-transform: uppercase;
      color:#fff;
      background: var(--red);
      cursor:pointer;
      box-shadow: 0 12px 18px rgba(0,0,0,.55);
      transition: transform .08s ease, filter .12s ease;
      min-width: 120px;
    }
    .voteBtn:active{ transform: scale(.98); }
    .voteBtn[disabled]{
      opacity:.55;
      cursor:not-allowed;
      filter: grayscale(.2);
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.78);
      border: 1px solid rgba(255,255,255,.08);
      color:#fff;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      max-width: 92vw;
      z-index: 9999;
      display:none;
      font-weight:700;
    }

    /* Debug overlay opcional */
    .diag{
      position:fixed;
      left:10px;
      top:10px;
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.08);
      padding:10px;
      border-radius: 12px;
      z-index: 9999;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      line-height:1.35;
      display:none; /* pon√© block si quer√©s */
      max-width: 92vw;
    }

    /* Responsivo */
    @media (max-width: 520px){
      .wrap{ padding-left: 56px; }
      .logo{ width:72px; }
      .row{
        grid-template-columns: 56px 58px 1fr 16px 120px;
        gap: 12px;
      }
      .num{ font-size: 38px; }
      .top1 .num{ font-size: 48px; }
      .track{ font-size: 18px; }
      .artist{ font-size: 14px; }
      .voteBtn{ padding: 12px 16px; min-width: 110px; }
      .playBtn{ width: 52px; height: 52px; }
    }
  </style>

  <!-- Firebase compat (para runTransaction) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
</head>

<body>
  <div class="bg"></div>

  <div class="side"><div class="sideText">RANKING ON</div></div>

  <div class="wrap">
    <div class="top">
      <img class="logo" src="logotipo.png" alt="ON Radio" />
      <div class="titleBox">
        <h1 class="title">VOT√Å TU TEMA<br/>PREFERIDO</h1>
      </div>
      <div class="arrowHint" aria-hidden="true"></div>
    </div>

    <div class="footerSite">www.laonradio.com.ar</div>

    <div id="list"></div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="diag" class="diag"></div>

  <script>
    /*********
     * 0) CONFIG FIREBASE
     *********/
          const firebaseConfig = {
    apiKey: "AIzaSyC8XXef5k8hLmNL8ufIJsc7Sx5KTlRFdH8",
    authDomain: "on-radio-ranking.firebaseapp.com",
    databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
    projectId: "on-radio-ranking",
    storageBucket: "on-radio-ranking.firebasestorage.app",
    messagingSenderId: "311635352358",
    appId: "1:311635352358:web:257ff4821987f07d31ffe7"
  };.
// ====== PEG√Å AC√Å TU CONFIG (el mismo que ya usabas) ======
      // apiKey: "...",
      // authDomain: "...",
      // databaseURL: "https://on-radio-ranking-default-rtdb.firebaseio.com",
      // projectId: "...",
      // storageBucket: "...",
      // messagingSenderId: "...",
      // appId: "..."
    };

    // Si no pegaste config, cortamos con mensaje claro
    function requireConfig(){
      if(!firebaseConfig || !firebaseConfig.databaseURL){
        showToast("Falta pegar firebaseConfig (databaseURL). Sin eso no puede cargar el ranking.");
        throw new Error("Missing firebaseConfig.databaseURL");
      }
    }

    /*********
     * 1) Helpers UI
     *********/
    const $list = document.getElementById("list");
    const $toast = document.getElementById("toast");
    const $diag  = document.getElementById("diag");

    function showToast(msg){
      $toast.textContent = msg;
      $toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> $toast.style.display="none", 3200);
    }

    function setDiag(lines){
      // $diag.style.display = "block"; // descoment√° si quer√©s ver diag siempre
      $diag.innerHTML = lines.map(l => escapeHtml(l)).join("<br>");
    }
    function escapeHtml(s){
      return (s+"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // Capturar errores para que NO ‚Äúdesaparezca todo‚Äù sin aviso
    window.addEventListener("error", (e)=>{
      console.error(e.error || e.message);
      showToast("Error de script: mir√° Consola (F12) o mandame captura del error.");
    });

    /*********
     * 2) 1 voto por d√≠a TOTAL
     *********/
    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return ${y}-${m}-${day};
    }
    const VOTE_LOCK_KEY = "onradio_vote_lock_day";

    function canVoteToday(){
      return localStorage.getItem(VOTE_LOCK_KEY) !== todayKey();
    }
    function lockVoteToday(){
      localStorage.setItem(VOTE_LOCK_KEY, todayKey());
    }

    /*********
     * 3) Audio: 1 solo player global
     *********/
    const audio = new Audio();
    audio.preload = "none";
    let currentKey = null;

    function stopAudio(){
      audio.pause();
      audio.currentTime = 0;
      currentKey = null;
      document.querySelectorAll(".playBtn").forEach(b => b.classList.remove("playing"));
    }

    audio.addEventListener("ended", ()=>{
      currentKey = null;
      document.querySelectorAll(".playBtn").forEach(b => b.classList.remove("playing"));
    });

    /*********
     * 4) Firebase + ranking
     *********/
    requireConfig();
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const temasRef = db.ref("temas");
    const metaLastOrderRef = db.ref("meta/lastOrder"); // { key: position } o array
    const metaLastWriteRef = db.ref("meta/lastOrderUpdatedAt");

    // Debounce para actualizar meta sin spamear
    let saveOrderTimer = null;

    async function loadLastOrder(){
      const snap = await metaLastOrderRef.get();
      return snap.exists() ? snap.val() : null;
    }

    function computeTrends(sortedKeys, lastOrder){
      // lastOrder puede ser:
      // - objeto { key: posAnterior }
      // - array ["hacecalor","ladron",...]
      const lastPos = {};
      if(Array.isArray(lastOrder)){
        lastOrder.forEach((k, i)=> lastPos[k]=i+1);
      }else if(lastOrder && typeof lastOrder === "object"){
        Object.keys(lastOrder).forEach(k=> lastPos[k]=Number(lastOrder[k]));
      }

      const trends = {};
      sortedKeys.forEach((k, idx)=>{
        const now = idx+1;
        const prev = lastPos[k];
        if(!prev) trends[k] = "same";
        else if(now < prev) trends[k] = "up";
        else if(now > prev) trends[k] = "down";
        else trends[k] = "same";
      });
      return trends;
    }

    function scheduleSaveOrder(sortedKeys){
      clearTimeout(saveOrderTimer);
      saveOrderTimer = setTimeout(async ()=>{
        try{
          // Guardamos array para simpleza
          await metaLastOrderRef.set(sortedKeys);
          await metaLastWriteRef.set(Date.now());
        }catch(err){
          console.warn("No se pudo guardar meta/lastOrder:", err);
        }
      }, 700);
    }

    function renderList(temasObj, trends){
      const entries = Object.entries(temasObj || {});
      // Normalizamos, por si falta votos
      const arr = entries.map(([key, t])=>({
        key,
        nombre: (t && t.nombre) ? String(t.nombre) : key,
        artista: (t && t.artista) ? String(t.artista) : "",
        audio: (t && t.audio) ? String(t.audio) : "",
        votos: (t && typeof t.votos === "number") ? t.votos : Number(t.votos || 0)
      }));

      // Orden por votos desc, y por nombre como desempate estable
      arr.sort((a,b)=>{
        if(b.votos !== a.votos) return b.votos - a.votos;
        return a.nombre.localeCompare(b.nombre);
      });

      // Top 10
      const top10 = arr.slice(0, 10);

      // Guardamos el orden actual para comparar a futuro
      scheduleSaveOrder(top10.map(x=>x.key));

      // Render
      $list.innerHTML = "";
      const lock = !canVoteToday();

      top10.forEach((t, idx)=>{
        const pos = idx+1;

        const row = document.createElement("div");
        row.className = "row" + (pos===1 ? " top1" : "");
        row.dataset.key = t.key;

        const num = document.createElement("div");
        num.className = "num";
        num.textContent = pos;

        const play = document.createElement("div");
        play.className = "playBtn";
        play.title = "Reproducir / Pausar";
        play.innerHTML = <div class="playIcon"></div>;
        play.addEventListener("click", ()=>{
          // Si no hay audio cargado, avisamos
          if(!t.audio){
            showToast("Este tema no tiene audio asignado en Firebase.");
            return;
          }

          // Si es el mismo tema: toggle play/pause
          if(currentKey === t.key){
            if(audio.paused){
              audio.play().catch(()=> showToast("No se pudo reproducir (bloqueo del navegador). Toc√° play otra vez."));
              play.classList.add("playing");
            }else{
              audio.pause();
              play.classList.remove("playing");
            }
            return;
          }

          // Si es otro: parar anterior + cargar nuevo
          stopAudio();
          currentKey = t.key;
          audio.src = t.audio; // mp3 en la ra√≠z del repo (como tus archivos)
          audio.play().catch(()=> showToast("No se pudo reproducir (bloqueo del navegador). Toc√° play otra vez."));
          play.classList.add("playing");
        });

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <p class="track">${escapeHtml(t.nombre)}</p>
          <p class="artist">${escapeHtml(t.artista)}</p>
        `;

        const trend = document.createElement("span");
        const tr = trends?.[t.key] || "same";
        trend.className = "trend " + (tr==="up" ? "up" : tr==="down" ? "down" : "same");

        const vote = document.createElement("button");
        vote.className = "voteBtn";
        vote.textContent = lock ? "YA VOTASTE" : "VOTAR";
        vote.disabled = lock;

        vote.addEventListener("click", async ()=>{
          if(!canVoteToday()){
            showToast("Ya votaste hoy. Volv√© ma√±ana üòâ");
            return;
          }

          try{
            vote.disabled = true;

            // Transaction: incrementa votos de forma segura
            const votosRef = db.ref(temas/${t.key}/votos);
            await votosRef.transaction((cur)=>{
              if(typeof cur !== "number") cur = Number(cur || 0);
              return cur + 1;
            });

            lockVoteToday();

            // Bloquea todos los botones
            document.querySelectorAll(".voteBtn").forEach(b=>{
              b.disabled = true;
              b.textContent = "YA VOTASTE";
            });

            showToast("¬°Gracias por votar en el Ranking ON! Volv√© ma√±ana üî•");

          }catch(err){
            console.error(err);
            vote.disabled = false;
            showToast("No se pudo registrar el voto. Revis√° reglas / conexi√≥n.");
          }
        });

        row.append(num, play, meta, trend, vote);
        $list.appendChild(row);
      });

      // Si hay audio sonando y re-renderiz√≥, mantener icono del actual
      if(currentKey){
        const btn = document.querySelector(.row[data-key="${CSS.escape(currentKey)}"] .playBtn);
        if(btn && !audio.paused) btn.classList.add("playing");
      }
    }

    async function boot(){
      setDiag([
        "DIAG: arrancando...",
        "Nodo: /temas",
        "Tip: si no renderiza, es error de JS/CSS/IDs."
      ]);

      const lastOrder = await loadLastOrder();

      temasRef.on("value", (snap)=>{
        const temas = snap.val() || {};
        const keys = Object.keys(temas);

        setDiag([
          "DIAG: OK",
          "Nodo detectado: /temas",
          "Cantidad de temas: " + keys.length,
          "Renderizando..."
        ]);

        // Calculamos orden actual (para trends)
        const arr = Object.entries(temas).map(([k,t])=>({
          key:k,
          votos: (t && typeof t.votos==="number") ? t.votos : Number(t?.votos || 0),
          nombre: (t && t.nombre) ? String(t.nombre) : k
        }));
        arr.sort((a,b)=> (b.votos-a.votos) || a.nombre.localeCompare(b.nombre));
        const sortedKeys = arr.slice(0,10).map(x=>x.key);

        const trends = computeTrends(sortedKeys, lastOrder);
        renderList(temas, trends);
      });
    }

    boot();
  </script>
</body>
</html>
